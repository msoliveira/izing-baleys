'use strict';const a6=b,a8=b;(function(c,d){const a4=b,a5=b,e=c();while(!![]){try{const f=parseInt(a4(0x105))/0x1*(parseInt(a5(0x101))/0x2)+-parseInt(a4(0xf8))/0x3+-parseInt(a5(0x12e))/0x4+-parseInt(a4(0x122))/0x5+parseInt(a5(0xe9))/0x6*(-parseInt(a4(0xeb))/0x7)+-parseInt(a5(0x121))/0x8*(parseInt(a4(0xd8))/0x9)+parseInt(a4(0x10e))/0xa;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xdf9a7));var __importDefault=this&&this[a6(0x124)]||function(c){const a7=a6;return c&&c[a7(0xd6)]?c:{'default':c};};Object[a8(0x10f)](exports,'__esModule',{'value':!![]});const lodash_1=require('lodash'),Utils_1=require('./Utils'),Index_1=require('./Index'),User_1=__importDefault(require('../../models/User')),logger_1=require(a6(0x10c)),events={},JoinChatServer=c=>{const a9=a6,aa=a8,{user:d}=c['handshake'][a9(0x10a)];logger_1[aa(0x110)][a9(0xe1)](a9(0x130)+d['name']);const {tenantId:e}=d,f='socketData_'+e;let g;g=Index_1[aa(0x109)][f];if(g){if(aa(0xea)!=='AWgQE')g[a9(0xef)][d['id']]={'sockets':[c['id']],'user':d},g['sockets'][a9(0x127)](c),(0x0,Utils_1[aa(0xe6)])(c,a9(0xff));else return;}!g&&('izoPw'!==aa(0xee)?d=aa(0xe5):(Index_1[aa(0x109)][f]={'sockets':[],'usersOnline':{},'idleUsers':{}},g=Index_1[aa(0x109)][f],g['usersOnline'][d['id']]={'sockets':[c['id']],'user':d},g[aa(0x126)][aa(0x127)](c),(0x0,Utils_1[aa(0xe6)])(c,d[a9(0x128)]+a9(0xdc))));},UpdateUsers=c=>{const ab=a8,ac=a8,{user:d}=c['handshake']['auth'],e=ab(0xed)+d['tenantId'],f=Index_1[ac(0x109)][e],g=(0x0,Utils_1[ac(0x131)])(f[ac(0xef)]);(0x0,lodash_1['forEach'])(g,h=>{const ad=ac,ae=ab,i=h[ad(0xfd)],{sockets:j}=h;if(i&&j[ae(0xf1)]>0x0){if(ad(0x104)===ae(0x11e))return g&&h[ae(0xd6)]?i:{'default':j};else(0x0,lodash_1[ae(0xd1)])(j,l=>{const af=ae,ag=ad,m=(0x0,lodash_1[af(0xf0)])(f[ag(0x126)],n=>{return n['id']===l;});m&&((i[ag(0xfe)][ag(0x115)]||i[af(0xfe)][af(0x117)])&&m[af(0x129)](ag(0xec),g));});}});},UpdateOnlineBubbles=c=>{const ah=a6,ai=a6,{user:d}=c[ah(0xf5)][ah(0x10a)],e=ah(0xed)+d[ai(0x128)],f=Index_1['shared'][e],g=(0x0,lodash_1[ah(0x12d)])((0x0,lodash_1[ai(0x108)])((0x0,lodash_1[ah(0x138)])(f[ah(0xef)]),i=>{return i[0x0];})),h=(0x0,lodash_1['fromPairs'])((0x0,lodash_1[ai(0x108)])((0x0,lodash_1['toPairs'])(f['idleUsers']),i=>{return i[0x0];}));(0x0,Utils_1['sendToAllConnectedClients'])(c,d[ai(0x128)]+':chat:updateOnlineBubbles',{'sortedUserList':g,'sortedIdleList':h});},SpawnOpenChatWindows=c=>{const aj=a8,ak=a8,{user:d}=c[aj(0xf5)][aj(0x10a)],e=User_1[aj(0xcf)][ak(0x12a)](d['id']);(0x0,Utils_1['sendToSelf'])(c,aj(0x136),e);},spawnChatWindow=c=>{c['on']('spawnChatWindow',async d=>{const al=b,am=b,e=await User_1[al(0xcf)][am(0x12a)](d,{'attributes':['id','name',al(0x10b),'profile']});(0x0,Utils_1[al(0xe6)])(c,'spawnChatWindow',e);});},onSetUserIdle=c=>{const an=a6,ao=a6,{user:d}=c[an(0xf5)]['auth'],e=an(0xed)+d[an(0x128)];c['on'](d[an(0x128)]+an(0x137),()=>{const ap=an,aq=an;let f;f=Index_1[ap(0x109)][e];if(f){if(aq(0x134)!==aq(0x134)){let h=q[ap(0x109)][r];h?.[aq(0x125)][s['id']]&&delete h?.[ap(0x125)][E['id']],!h&&(F['shared'][G]={'sockets':[],'usersOnline':{},'idleUsers':{}},h=H[ap(0x109)][I],h[aq(0xef)]['push'](J['id'])),h?.[aq(0xef)]&&(h[ap(0xef)][K['id']]={'sockets':[L['id']],'user':M}),C(D);}else f['idleUsers'][d['id']]={'sockets':[c['id']],'user':d};}!f&&(aq(0xe4)!==aq(0xe4)?(g(h),i(j)):(Index_1[aq(0x109)][e]={'sockets':[],'usersOnline':{},'idleUsers':{}},f=Index_1[ap(0x109)][e],f[aq(0x125)]['push'](c['id']))),f?.['usersOnline'][d['id']]&&(aq(0xfb)!==aq(0xfb)?g['usersOnline'][h['id']]={'sockets':[i['id']],'user':j}:delete f?.[ap(0xef)][d['id']]),UpdateOnlineBubbles(c);});},onSetUserActive=c=>{const ar=a6,as=a6,{user:d}=c[ar(0xf5)]['auth'],e='socketData_'+d[ar(0x128)];c['on'](d['tenantId']+as(0x12b),()=>{const at=as,au=ar;let f=Index_1[at(0x109)][e];if(f?.[au(0x125)][d['id']]){if(at(0x111)!==at(0x11b))delete f?.[au(0x125)][d['id']];else return d[0x0];}!f&&(Index_1[at(0x109)][e]={'sockets':[],'usersOnline':{},'idleUsers':{}},f=Index_1[at(0x109)][e],f[au(0xef)][au(0x127)](c['id'])),f?.[au(0xef)]&&(f[au(0xef)][d['id']]={'sockets':[c['id']],'user':d}),UpdateOnlineBubbles(c);});},onUpdateUsers=c=>{const av=a8;c['on'](av(0xec),UpdateUsers);},onChatMessage=c=>{const aw=a8,ax=a6,{user:d}=c[aw(0xf5)][aw(0x10a)],{tenantId:e}=d,f=ax(0xed)+e;c['on'](ax(0xf6),function(g){const ay=ax,az=aw;if('YeiGr'!==ay(0xd3)){const h=Index_1[ay(0x109)][f];if(h){if(ay(0xd4)!=='SmSgm')return d[0x0];else{const {to:j}=g,{from:k}=g;console[az(0x102)]('TO',j),console[az(0x102)](ay(0x113),k);const l=g[az(0xce)];if(g['type']==='s'){if(ay(0xe0)!==ay(0x103))g[ay(0xce)]='r';else{const {user:n}=f['handshake'][az(0x10a)];g['on'](n[ay(0x128)]+az(0xf4),()=>{const aA=az;i(n[aA(0x128)]);});}}else g[ay(0xce)]='s';(0x0,Utils_1[az(0x118)])(h[az(0x126)],h[ay(0xef)],g[ay(0x11d)][az(0xe8)],az(0xf6),g),g[ay(0xce)]=l,(0x0,Utils_1[ay(0x118)])(h['sockets'],h[az(0xef)],g['fromUser'][ay(0xe8)],'chatMessage',g);}}}else{const {to:o}=v,{from:p}=w;x[ay(0x102)]('TO',o),y[az(0x102)](az(0x113),p);const q=z[az(0xce)];A['type']==='s'?O[az(0xce)]='r':P['type']='s',(0x0,D[az(0x118)])(E[az(0x126)],F[ay(0xef)],G[ay(0x11d)][ay(0xe8)],az(0xf6),H),I['type']=q,(0x0,J[az(0x118)])(K[ay(0x126)],L[az(0xef)],M[az(0x112)][az(0xe8)],az(0xf6),N);}});},onChatTyping=c=>{const aB=a8,aC=a8,{user:d}=c[aB(0xf5)]['auth'],{tenantId:e}=d,f=aC(0xed)+e;c['on'](aB(0x132),g=>{const aD=aB,aE=aC;if(aD(0xde)===aD(0x11f))d['type']='r';else{const i=Index_1[aE(0x109)][f];if(i){const {to:j}=g,{from:k}=g;let l=null,m=null;(0x0,lodash_1[aD(0xf0)])(i[aD(0xef)],function(n){const aF=aE,aG=aE;String(n[aF(0xfd)]['id'])===String(j)&&(aF(0x119)==='mBHXK'?l=n[aG(0xfd)]:e(f)),String(n[aG(0xfd)]['id'])===String(k)&&(m=n[aF(0xfd)]);});if((0x0,lodash_1[aD(0xf9)])(l)||(0x0,lodash_1[aD(0xf9)])(m)){if(aE(0x11a)!==aD(0xda))return;else{if(t['usersOnline'][u['id']]){const p=K[aD(0xef)][L['id']]['sockets'];(0x0,M[aE(0xd9)])(p)<0x2?delete T[aD(0xef)][U['id']]:V[aE(0xef)][W['id']][aE(0x126)]=(0x0,X[aE(0x120)])(p,Y['id']);}const o=(0x0,E[aD(0xf3)])(F[aD(0x126)],{'id':G['id']});H['sockets']=(0x0,I[aD(0x120)])(J[aD(0x126)],o);}}g[aD(0x11d)]=l,g[aD(0x112)]=m,(0x0,Utils_1[aE(0x118)])(i['sockets'],i['usersOnline'],l[aD(0xdf)],aD(0x132),g);}}});},onChatStopTyping=c=>{const aH=a6,aI=a8,{user:d}=c[aH(0xf5)][aI(0x10a)],{tenantId:e}=d,f=aI(0xed)+e;c['on']('chatStopTyping',g=>{const aJ=aH,aK=aH,h=Index_1[aJ(0x109)][f];if(h){const {to:i}=g;let j=null;(0x0,lodash_1[aJ(0xf0)])(h[aJ(0xef)],k=>{const aL=aK;String(k[aL(0xfd)]['id'])===String(i)&&(j=k['user']);});if((0x0,lodash_1[aK(0xf9)])(j)){if(aK(0xdd)!=='OSVHt')h['idleUsers'][i['id']]['sockets']=(0x0,j[aK(0x120)])(k,l['id']);else return;}g[aK(0x11d)]=j,(0x0,Utils_1['sendToUser'])(h[aJ(0x126)],h[aK(0xef)],j[aJ(0xdf)],aJ(0x135),g);}});},saveChatWindow=c=>{const aM=a6;c['on'](aM(0xfc),async d=>{const aN=aM,aO=aM;if('iRWPX'===aN(0xdb)){const {userId:e}=d,{remove:f}=d,g=await User_1['default'][aO(0x12a)](e);if(g){if(f){}else{}}}else d[aN(0xce)]='s';});},onDisconnect=c=>{const aP=a8;c['on'](aP(0xe3),async d=>{const aQ=aP,aR=aP,{user:e}=c[aQ(0xf5)]['auth'],{tenantId:f}=e,g=aQ(0xed)+f,h=Index_1['shared'][g];if(h?.[aQ(0xef)]){if(aR(0xe2)===aR(0x123)){const {to:l}=n;let m=null;(0x0,o[aQ(0xf0)])(p[aQ(0xef)],B=>{const aS=aQ,aT=aR;m(B[aS(0xfd)]['id'])===z(l)&&(m=B[aT(0xfd)]);});if((0x0,s[aR(0xf9)])(m))return;t[aQ(0x11d)]=m,(0x0,u[aR(0x118)])(v[aR(0x126)],w[aQ(0xef)],m[aR(0xdf)],aQ(0x135),x);}else{if(h[aR(0xef)][e['id']]){const m=h[aR(0xef)][e['id']][aR(0x126)];if((0x0,lodash_1['size'])(m)<0x2){if(aR(0xd0)===aQ(0x12f)){const {user:p}=p[aR(0xf5)]['auth'];q['logger']['info'](aQ(0x130)+p[aQ(0xdf)]);const {tenantId:q}=p,r=aQ(0xed)+q;let s;s=r['shared'][r],s&&(s[aQ(0xef)][p['id']]={'sockets':[C['id']],'user':p},s['sockets']['push'](D),(0x0,E[aQ(0xe6)])(F,aR(0xff))),!s&&(G[aQ(0x109)][r]={'sockets':[],'usersOnline':{},'idleUsers':{}},s=H[aQ(0x109)][r],s[aR(0xef)][p['id']]={'sockets':[I['id']],'user':p},s['sockets'][aQ(0x127)](J),(0x0,K[aQ(0xe6)])(L,p['tenantId']+':joinSuccessfully'));}else delete h[aR(0xef)][e['id']];}else h['usersOnline'][e['id']][aR(0x126)]=(0x0,lodash_1[aR(0x120)])(m,c['id']);}const l=(0x0,lodash_1['findKey'])(h[aQ(0x126)],{'id':c['id']});h['sockets']=(0x0,lodash_1[aR(0x120)])(h['sockets'],l);}}if(h?.[aR(0x125)]){if(h[aR(0x125)][e['id']]){const q=h[aQ(0x125)][e['id']][aQ(0x126)];(0x0,lodash_1[aQ(0xd9)])(q)<0x2?aQ(0x133)!==aR(0xf2)?delete h[aQ(0x125)][e['id']]:delete e?.[aQ(0x125)][f['id']]:h[aR(0x125)][e['id']][aQ(0x126)]=(0x0,lodash_1[aR(0x120)])(q,c['id']);}const p=(0x0,lodash_1[aR(0xf3)])(h['sockets'],{'id':c['id']});h[aR(0x126)]=(0x0,lodash_1[aQ(0x120)])(h[aQ(0x126)],p);}const j=await User_1[aR(0xcf)]['findByPk'](e['id']);j?.['update']({'status':aQ(0x116),'lastOnline':new Date()}),UpdateOnlineBubbles(c),d==='transport\x20error'&&(d=aR(0xe5)),logger_1[aQ(0x110)]['debug']('User\x20disconnected\x20('+d+'):\x20'+e[aR(0xdf)]+aQ(0x106)+c['id']);});};function b(c,d){const e=a();return b=function(f,g){f=f-0xce;let h=e[f];return h;},b(c,d);}events[a6(0x12c)]=onSetUserIdle,events[a8(0x100)]=onSetUserActive,events[a8(0xd2)]=onUpdateUsers,events['spawnChatWindow']=spawnChatWindow,events[a6(0xd5)]=onChatMessage,events[a8(0xf7)]=onChatTyping,events['onChatStopTyping']=onChatStopTyping,events[a8(0xfc)]=saveChatWindow,events['onDisconnect']=onDisconnect,events['updateOnlineBubbles']=c=>{const aU=a6,aV=a6,{user:d}=c[aU(0xf5)][aU(0x10a)];c['on'](d[aU(0x128)]+':chat:updateOnlineBubbles',()=>{const aW=aV,aX=aV;if(aW(0xe7)===aX(0xfa)){const {user:f}=m[aW(0xf5)][aX(0x10a)],g=aX(0xed)+f[aW(0x128)],h=n['shared'][g],i=(0x0,o[aW(0x12d)])((0x0,p['sortBy'])((0x0,q[aW(0x138)])(h[aW(0xef)]),B=>{return B[0x0];})),j=(0x0,r['fromPairs'])((0x0,s[aX(0x108)])((0x0,t[aW(0x138)])(h['idleUsers']),B=>{return B[0x0];}));(0x0,u[aX(0x107)])(v,f[aW(0x128)]+aW(0xf4),{'sortedUserList':i,'sortedIdleList':j});}else UpdateOnlineBubbles(d[aW(0x128)]);});},events[a6(0x10d)]=c=>{const aY=a8;c['on'](aY(0x10d),()=>{SpawnOpenChatWindows(c);});};function register(c){const aZ=a8,b0=a8;if(!c[aZ(0xf5)]?.[aZ(0x10a)]?.[b0(0x128)]){if(aZ(0x11c)!=='yGfHC')return;else g['idleUsers'][h['id']]={'sockets':[i['id']],'user':j};}events[b0(0x12c)](c),events[aZ(0x100)](c),events['onUpdateUsers'](c),events[aZ(0xd7)](c),events[b0(0x136)](c),events[aZ(0x10d)](c),events[b0(0xd5)](c),events[b0(0xf7)](c),events['onChatStopTyping'](c),events[b0(0xfc)](c),events[aZ(0x114)](c),c[aZ(0xf5)][b0(0x10a)][aZ(0xfd)]['id']&&JoinChatServer(c);}const eventLoop=c=>{UpdateUsers(c),UpdateOnlineBubbles(c);},chat={'events':events,'eventLoop':eventLoop,'register':register};function a(){const b1=[':setUserIdle','toPairs','type','default','ETSsJ','forEach','onUpdateUsers','VHSVN','SmSgm','onChatMessage','__esModule','updateOnlineBubbles','36WEQcCP','size','vkjIf','iRWPX',':joinSuccessfully','OSVHt','xquyP','name','NvLck','info','GQfss','disconnect','TMiim','client\x20terminated','sendToSelf','Zodcm','username','5226222fSPTQs','kBRZX','7xQiDvG','updateUsers','socketData_','izoPw','usersOnline','find','length','VlaLt','findKey',':chat:updateOnlineBubbles','handshake','chatMessage','onChatTyping','64671iNVAKm','isNull','zMotL','aevzz','saveChatWindow','user','role','joinSuccessfully','onSetUserActive','108dqEwgt','log','RXYyN','aaetn','3408IsbVjX','\x20-\x20','sendToAllConnectedClients','sortBy','shared','auth','email','../../utils/logger','getOpenChatWindows','58677170ZUWUdj','defineProperty','logger','lQAmT','fromUser','FROM','onDisconnect','isAdmin','offline','isAgent','sendToUser','mBHXK','WADzU','lbYhG','LsLGL','toUser','Wivad','bSAPa','without','2423912VowPCJ','6783970ajnXNT','YCXqq','__importDefault','idleUsers','sockets','push','tenantId','emit','findByPk',':setUserActive','onSetUserIdle','fromPairs','6698104WjgiEI','KmlfJ','joinChatServer\x20USER\x20','sortByKeys','chatTyping','wnote','RPPgv','chatStopTyping','spawnChatWindow'];a=function(){return b1;};return a();}exports[a8(0xcf)]=chat;