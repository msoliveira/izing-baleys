'use strict';const a7=b,a8=b;(function(c,d){const a4=b,a5=b,e=c();while(!![]){try{const f=-parseInt(a4(0x1b4))/0x1+parseInt(a5(0x198))/0x2*(parseInt(a5(0x17b))/0x3)+-parseInt(a4(0x185))/0x4+parseInt(a4(0x1b7))/0x5*(parseInt(a5(0x195))/0x6)+parseInt(a5(0x189))/0x7+parseInt(a4(0x1b5))/0x8+parseInt(a4(0x15f))/0x9;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x8fe7d));function a(){const aY=['joinChatServer\x20USER\x20','biwzS','updateUsers','size','spawnChatWindow','Mrxkx','isAgent','toPairs','findKey','sortBy','onDisconnect','chatMessage','findByPk','onSetUserIdle','tofAG','onChatTyping','xaXDV','NlOiA','update','3466245yCbqMH','shared','push','profile','sendToUser','uzEkJ','tenantId','username','debug','info','3977376CDXMlx','sockets','fromPairs','onChatMessage','123592ibmrEq','socketData_','__esModule','gMaiL','fromUser','isAdmin','jNAHl','handshake','jzqAL','saveChatWindow','role','toUser','6UWaDZL','chatStopTyping','isNull','2gfuCVd','GCurx',':setUserActive',':chat:updateOnlineBubbles',':joinSuccessfully','joinSuccessfully','emit','email','IXmvL','onChatStopTyping','CibOE','onUpdateUsers','Xbrxn','sendToSelf','tirhl','./Utils','getOpenChatWindows','auth','defineProperty','without','default','updateOnlineBubbles','name','forEach','chatTyping','logger','length','kTNPT','964416MRFlHA','1242944PixuuC','idleUsers','5123635KvitEb','disconnect','find','lodash','1755279XXtlHp','onSetUserActive','../../utils/logger','type','sendToAllConnectedClients','usersOnline','user','KaQiY','ytnXR'];a=function(){return aY;};return a();}var __importDefault=this&&this['__importDefault']||function(c){const a6=b;return c&&c[a6(0x18b)]?c:{'default':c};};Object[a7(0x1aa)](exports,'__esModule',{'value':!![]});const lodash_1=require(a7(0x1ba)),Utils_1=require(a8(0x1a7)),Index_1=require('./Index'),User_1=__importDefault(require('../../models/User')),logger_1=require(a8(0x161)),events={},JoinChatServer=c=>{const a9=a8,aa=a7,{user:d}=c[a9(0x190)][aa(0x1a9)];logger_1[aa(0x1b1)][a9(0x184)](a9(0x168)+d['name']);const {tenantId:e}=d,f=aa(0x18a)+e;let g;g=Index_1[a9(0x17c)][f];if(g){if('JoWwy'!==a9(0x18f))g[aa(0x164)][d['id']]={'sockets':[c['id']],'user':d},g[a9(0x186)][aa(0x17d)](c),(0x0,Utils_1[a9(0x1a5)])(c,aa(0x19d));else{if(t[aa(0x1b6)][u['id']]){const j=K['idleUsers'][L['id']]['sockets'];(0x0,M[aa(0x16b)])(j)<0x2?delete T[aa(0x1b6)][U['id']]:V[aa(0x1b6)][W['id']][a9(0x186)]=(0x0,X['without'])(j,Y['id']);}const i=(0x0,E[aa(0x170)])(F[aa(0x186)],{'id':G['id']});H[a9(0x186)]=(0x0,I[a9(0x1ab)])(J[aa(0x186)],i);}}!g&&(Index_1[a9(0x17c)][f]={'sockets':[],'usersOnline':{},'idleUsers':{}},g=Index_1[a9(0x17c)][f],g[a9(0x164)][d['id']]={'sockets':[c['id']],'user':d},g[a9(0x186)][aa(0x17d)](c),(0x0,Utils_1[a9(0x1a5)])(c,d[a9(0x181)]+':joinSuccessfully'));},UpdateUsers=c=>{const ab=a7,ac=a7,{user:d}=c['handshake']['auth'],e=ab(0x18a)+d[ac(0x181)],f=Index_1[ab(0x17c)][e],g=(0x0,Utils_1['sortByKeys'])(f[ab(0x164)]);(0x0,lodash_1[ab(0x1af)])(g,h=>{const ad=ab,ae=ab,i=h[ad(0x165)],{sockets:j}=h;i&&j[ae(0x1b2)]>0x0&&(0x0,lodash_1[ae(0x1af)])(j,k=>{const af=ae,ag=ad;if(af(0x167)!=='ytnXR'){let m=q[ag(0x17c)][r];m?.['idleUsers'][s['id']]&&delete m?.[ag(0x1b6)][E['id']],!m&&(F[ag(0x17c)][G]={'sockets':[],'usersOnline':{},'idleUsers':{}},m=H['shared'][I],m[af(0x164)][af(0x17d)](J['id'])),m?.[af(0x164)]&&(m[ag(0x164)][K['id']]={'sockets':[L['id']],'user':M}),C(D);}else{const m=(0x0,lodash_1['find'])(f[ag(0x186)],n=>{const ah=ag,ai=af;if(ah(0x180)===ah(0x180))return n['id']===k;else e=f[ai(0x165)];});m&&((i[af(0x193)]['isAdmin']||i[ag(0x193)][ag(0x16e)])&&m[af(0x19e)](ag(0x16a),g));}});});},UpdateOnlineBubbles=c=>{const aj=a8,ak=a8,{user:d}=c[aj(0x190)][aj(0x1a9)],e=ak(0x18a)+d[aj(0x181)],f=Index_1[ak(0x17c)][e],g=(0x0,lodash_1[aj(0x187)])((0x0,lodash_1[aj(0x171)])((0x0,lodash_1[aj(0x16f)])(f[aj(0x164)]),i=>{return i[0x0];})),h=(0x0,lodash_1[aj(0x187)])((0x0,lodash_1['sortBy'])((0x0,lodash_1[ak(0x16f)])(f[aj(0x1b6)]),i=>{return i[0x0];}));(0x0,Utils_1[aj(0x163)])(c,d[ak(0x181)]+':chat:updateOnlineBubbles',{'sortedUserList':g,'sortedIdleList':h});},SpawnOpenChatWindows=c=>{const al=a7,am=a7,{user:d}=c[al(0x190)][am(0x1a9)],e=User_1[al(0x1ac)][am(0x174)](d['id']);(0x0,Utils_1[al(0x1a5)])(c,'spawnChatWindow',e);},spawnChatWindow=c=>{c['on']('spawnChatWindow',async d=>{const an=b,ao=b;if(an(0x1a0)!==ao(0x1a0))k[an(0x164)][l['id']]={'sockets':[m['id']],'user':n},o[an(0x186)]['push'](p),(0x0,q[ao(0x1a5)])(r,an(0x19d));else{const f=await User_1['default'][an(0x174)](d,{'attributes':['id','name',an(0x19f),ao(0x17e)]});(0x0,Utils_1[an(0x1a5)])(c,ao(0x16c),f);}});},onSetUserIdle=c=>{const ap=a8,aq=a7,{user:d}=c[ap(0x190)][aq(0x1a9)],e=aq(0x18a)+d[aq(0x181)];c['on'](d[ap(0x181)]+':setUserIdle',()=>{const ar=aq,as=aq;let f;f=Index_1[ar(0x17c)][e];f&&(f[ar(0x1b6)][d['id']]={'sockets':[c['id']],'user':d});!f&&(Index_1[ar(0x17c)][e]={'sockets':[],'usersOnline':{},'idleUsers':{}},f=Index_1['shared'][e],f['idleUsers'][ar(0x17d)](c['id']));if(f?.['usersOnline'][d['id']]){if(ar(0x166)===ar(0x166))delete f?.['usersOnline'][d['id']];else{if(d){}else{}}}UpdateOnlineBubbles(c);});},onSetUserActive=c=>{const at=a7,au=a8,{user:d}=c[at(0x190)]['auth'],e=at(0x18a)+d[at(0x181)];c['on'](d[au(0x181)]+at(0x19a),()=>{const av=at,aw=at;let f=Index_1[av(0x17c)][e];f?.[aw(0x1b6)][d['id']]&&delete f?.[aw(0x1b6)][d['id']],!f&&(aw(0x1b3)!==aw(0x1a6)?(Index_1[aw(0x17c)][e]={'sockets':[],'usersOnline':{},'idleUsers':{}},f=Index_1[aw(0x17c)][e],f[aw(0x164)][av(0x17d)](c['id'])):e(f)),f?.['usersOnline']&&(f[aw(0x164)][d['id']]={'sockets':[c['id']],'user':d}),UpdateOnlineBubbles(c);});},onUpdateUsers=c=>{const ax=a7;c['on'](ax(0x16a),UpdateUsers);},onChatMessage=c=>{const ay=a7,az=a8,{user:d}=c[ay(0x190)]['auth'],{tenantId:e}=d,f=az(0x18a)+e;c['on'](az(0x173),function(g){const aA=az,aB=az;if('daNnK'===aA(0x191)){const {user:i}=g['handshake']['auth'],j=h[aA(0x1ac)]['findByPk'](i['id']);(0x0,i[aA(0x1a5)])(j,'spawnChatWindow',j);}else{const i=Index_1[aB(0x17c)][f];if(i){const {to:j}=g,{from:k}=g;console['log']('TO',j),console['log']('FROM',k);const l=g[aB(0x162)];g['type']==='s'?g[aB(0x162)]='r':g['type']='s',(0x0,Utils_1['sendToUser'])(i[aB(0x186)],i[aA(0x164)],g[aB(0x194)][aA(0x182)],aB(0x173),g),g[aB(0x162)]=l,(0x0,Utils_1[aA(0x17f)])(i[aA(0x186)],i[aB(0x164)],g[aA(0x18d)][aA(0x182)],aA(0x173),g);}}});},onChatTyping=c=>{const aC=a8,aD=a8,{user:d}=c[aC(0x190)][aD(0x1a9)],{tenantId:e}=d,f='socketData_'+e;c['on'](aD(0x1b0),g=>{const aE=aD,aF=aD,h=Index_1[aE(0x17c)][f];if(h){const {to:i}=g,{from:j}=g;let k=null,l=null;(0x0,lodash_1[aE(0x1b9)])(h[aF(0x164)],function(m){const aG=aE,aH=aE;String(m[aG(0x165)]['id'])===String(i)&&(k=m[aG(0x165)]),String(m['user']['id'])===String(j)&&(l=m[aH(0x165)]);});if((0x0,lodash_1[aF(0x197)])(k)||(0x0,lodash_1['isNull'])(l)){if('Mrxkx'===aF(0x16d))return;else return;}g[aF(0x194)]=k,g['fromUser']=l,(0x0,Utils_1[aF(0x17f)])(h[aF(0x186)],h[aE(0x164)],k['name'],aF(0x1b0),g);}});},onChatStopTyping=c=>{const aI=a8,aJ=a8,{user:d}=c[aI(0x190)][aI(0x1a9)],{tenantId:e}=d,f=aJ(0x18a)+e;c['on'](aI(0x196),g=>{const aK=aJ,aL=aJ;if('jxgem'!==aK(0x199)){const h=Index_1[aK(0x17c)][f];if(h){const {to:i}=g;let j=null;(0x0,lodash_1['find'])(h['usersOnline'],k=>{const aM=aK,aN=aL;if(String(k[aM(0x165)]['id'])===String(i)){if(aN(0x18c)!==aN(0x176))j=k[aM(0x165)];else{const {user:m}=p[aN(0x190)][aN(0x1a9)];q[aM(0x1b1)][aM(0x184)]('joinChatServer\x20USER\x20'+m[aM(0x1ae)]);const {tenantId:n}=m,o=aM(0x18a)+n;let p;p=r[aM(0x17c)][o],p&&(p['usersOnline'][m['id']]={'sockets':[C['id']],'user':m},p[aN(0x186)]['push'](D),(0x0,E['sendToSelf'])(F,aN(0x19d))),!p&&(G[aM(0x17c)][o]={'sockets':[],'usersOnline':{},'idleUsers':{}},p=H[aM(0x17c)][o],p[aN(0x164)][m['id']]={'sockets':[I['id']],'user':m},p[aN(0x186)][aN(0x17d)](J),(0x0,K[aN(0x1a5)])(L,m[aN(0x181)]+aN(0x19c)));}}});if((0x0,lodash_1[aK(0x197)])(j))return;g[aL(0x194)]=j,(0x0,Utils_1[aK(0x17f)])(h[aL(0x186)],h[aL(0x164)],j[aK(0x1ae)],aL(0x196),g);}}else{const l=l[aL(0x164)][m['id']][aL(0x186)];(0x0,n['size'])(l)<0x2?delete u[aL(0x164)][v['id']]:w[aK(0x164)][x['id']][aL(0x186)]=(0x0,y[aL(0x1ab)])(l,z['id']);}});},saveChatWindow=c=>{const aO=a7;c['on'](aO(0x192),async d=>{const aP=aO,aQ=aO,{userId:e}=d,{remove:f}=d,g=await User_1[aP(0x1ac)][aP(0x174)](e);if(g){if(f){}else{}}});},onDisconnect=c=>{const aR=a7;c['on'](aR(0x1b8),async d=>{const aS=aR,aT=aR,{user:e}=c[aS(0x190)][aT(0x1a9)],{tenantId:f}=e,g=aT(0x18a)+f,h=Index_1['shared'][g];if(h?.[aS(0x164)]){if(aS(0x178)===aT(0x178)){if(h['usersOnline'][e['id']]){const l=h[aT(0x164)][e['id']]['sockets'];(0x0,lodash_1[aS(0x16b)])(l)<0x2?delete h[aT(0x164)][e['id']]:h[aS(0x164)][e['id']][aS(0x186)]=(0x0,lodash_1['without'])(l,c['id']);}const k=(0x0,lodash_1['findKey'])(h['sockets'],{'id':c['id']});h[aS(0x186)]=(0x0,lodash_1[aT(0x1ab)])(h[aS(0x186)],k);}else f['on'](aS(0x1a8),()=>{i(j);});}if(h?.[aS(0x1b6)]){if(h['idleUsers'][e['id']]){if(aT(0x1a2)==='CibOE'){const p=h[aT(0x1b6)][e['id']][aT(0x186)];(0x0,lodash_1['size'])(p)<0x2?delete h[aT(0x1b6)][e['id']]:h[aS(0x1b6)][e['id']][aT(0x186)]=(0x0,lodash_1[aT(0x1ab)])(p,c['id']);}else return g&&h[aT(0x18b)]?n:{'default':j};}const n=(0x0,lodash_1[aT(0x170)])(h[aS(0x186)],{'id':c['id']});h[aS(0x186)]=(0x0,lodash_1['without'])(h['sockets'],n);}const j=await User_1['default'][aT(0x174)](e['id']);j?.[aT(0x17a)]({'status':'offline','lastOnline':new Date()}),UpdateOnlineBubbles(c),d==='transport\x20error'&&(aT(0x179)!==aS(0x169)?d='client\x20terminated':(g['role'][aT(0x18e)]||h[aT(0x193)]['isAgent'])&&k['emit'](aT(0x16a),l)),logger_1[aS(0x1b1)][aT(0x183)]('User\x20disconnected\x20('+d+'):\x20'+e[aS(0x1ae)]+'\x20-\x20'+c['id']);});};function b(c,d){const e=a();return b=function(f,g){f=f-0x15f;let h=e[f];return h;},b(c,d);}events[a7(0x175)]=onSetUserIdle,events[a8(0x160)]=onSetUserActive,events['onUpdateUsers']=onUpdateUsers,events[a8(0x16c)]=spawnChatWindow,events[a8(0x188)]=onChatMessage,events[a8(0x177)]=onChatTyping,events[a8(0x1a1)]=onChatStopTyping,events['saveChatWindow']=saveChatWindow,events[a7(0x172)]=onDisconnect,events[a8(0x1ad)]=c=>{const aU=a7,aV=a7,{user:d}=c[aU(0x190)][aU(0x1a9)];c['on'](d[aV(0x181)]+aV(0x19b),()=>{UpdateOnlineBubbles(d['tenantId']);});},events[a7(0x1a8)]=c=>{c['on']('getOpenChatWindows',()=>{SpawnOpenChatWindows(c);});};function register(c){const aW=a7,aX=a8;if(!c[aW(0x190)]?.['auth']?.['tenantId'])return;events[aW(0x175)](c),events[aX(0x160)](c),events[aX(0x1a3)](c),events[aX(0x1ad)](c),events[aW(0x16c)](c),events[aW(0x1a8)](c),events[aW(0x188)](c),events[aX(0x177)](c),events[aW(0x1a1)](c),events[aW(0x192)](c),events[aX(0x172)](c),c[aW(0x190)][aW(0x1a9)][aX(0x165)]['id']&&(aX(0x1a4)!=='ZoXDS'?JoinChatServer(c):delete e['usersOnline'][f['id']]);}const eventLoop=c=>{UpdateUsers(c),UpdateOnlineBubbles(c);},chat={'events':events,'eventLoop':eventLoop,'register':register};exports['default']=chat;