'use strict';const z=b,B=b;function b(c,d){const e=a();return b=function(f,g){f=f-0x182;let h=e[f];return h;},b(c,d);}function a(){const G=['text','__esModule','12763552VGbOZx','sequelize','join','directThread','chat','../../models/Ticket','sleepRandomTime','../../utils/logger','mp4','.mp4','sended','closed','__importDefault','info','contact','broadcastVideo','includes','sendMessage\x20media','ptt','chat:ack','ticket','Message\x20Update\x20ok','mediaName','logger','createdAt','body','mediaUrl','item_id','11320DDuQbW','toFormat','2844852hLEgtO','4643028ewxBQU','instagramPK','image','public','readFile','Error\x20message\x20is\x20(tenant:\x20','audio','log','saveToFile','error','jpeg','\x20|\x20Ticket:\x20','2644iKDyNS','quotedMsg','broadcastVoice','fluent-ffmpeg','114953hEXfxh','mediaType','5110vShDOx','default','7918211KVAgFD','../../helpers/socketEmit','findAll','dataValues','timestamp','sharp','update','entity','video','Error\x20send\x20message\x20(id:\x20','pending'];a=function(){return G;};return a();}(function(c,d){const x=b,y=b,e=c();while(!![]){try{const f=-parseInt(x(0x1a1))/0x1+parseInt(y(0x1a3))/0x2+parseInt(y(0x191))/0x3+-parseInt(y(0x19d))/0x4*(parseInt(x(0x18e))/0x5)+parseInt(y(0x190))/0x6+-parseInt(x(0x1a5))/0x7+parseInt(x(0x1b2))/0x8;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xd6283));var __importDefault=this&&this[z(0x1be)]||function(c){const A=z;return c&&c[A(0x1b1)]?c:{'default':c};};Object['defineProperty'](exports,z(0x1b1),{'value':!![]});const promises_1=require('fs/promises'),fluent_ffmpeg_1=__importDefault(require(z(0x1a0))),path_1=require('path'),sequelize_1=require(B(0x1b3)),sharp_1=__importDefault(require(B(0x1aa))),socketEmit_1=__importDefault(require(z(0x1a6))),Message_1=__importDefault(require('../../models/Message')),Ticket_1=__importDefault(require(z(0x1b7))),logger_1=require(B(0x1b9)),sleepRandomTime_1=require('../../utils/sleepRandomTime'),SendMessagesSystemWbot=async(c,d)=>{const C=B,D=z,e={'fromMe':!![],'messageId':{[sequelize_1['Op']['is']]:null},'status':C(0x1af),[sequelize_1['Op']['or']]:[{'scheduleDate':{[sequelize_1['Op']['lte']]:new Date()}},{'scheduleDate':{[sequelize_1['Op']['is']]:null}}]},f=await Message_1[D(0x1a4)][C(0x1a7)]({'where':e,'include':[D(0x1c0),{'model':Ticket_1[D(0x1a4)],'as':'ticket','where':{'tenantId':d,[sequelize_1['Op']['or']]:{'status':{[sequelize_1['Op']['ne']]:D(0x1bd)},'isFarewellMessage':!![]},'channel':'instagram','whatsappId':c['id']},'include':[C(0x1c0)]},{'model':Message_1['default'],'as':D(0x19e),'include':['contact']}],'order':[[C(0x18a),'ASC']]});let g;for(const h of f){const i=h,{ticket:j}=i,k=j[C(0x1c0)][C(0x192)],l=await c[D(0x1ac)][D(0x1b5)]([k]);try{if(![D(0x1b6),C(0x1b0)][C(0x182)](i[D(0x1a2)])&&i[C(0x188)]){const n=(0x0,path_1[C(0x1b4)])(__dirname,'..','..','..',C(0x194)),o=(0x0,path_1[C(0x1b4)])(n,i[C(0x188)]),p=await(0x0,promises_1[C(0x195)])(o);console[D(0x198)](o);if(i['mediaType']===C(0x197)||i[C(0x1a2)]===D(0x184)){const q=i[C(0x188)]['split']('.'),r=(0x0,path_1[C(0x1b4)])(n,q[0x0]+C(0x1bb));await new Promise((t,u)=>{const E=D,F=D;(0x0,fluent_ffmpeg_1[E(0x1a4)])(o)[E(0x18f)](F(0x1ba))['on'](E(0x19a),v=>u(v))['on']('end',()=>t(!![]))[F(0x199)](r);});const s=await(0x0,promises_1[D(0x195)])(r);g=await l[D(0x19f)]({'file':s});}if(i[D(0x1a2)]===C(0x193)){const t=await(0x0,sharp_1[D(0x1a4)])(p)[D(0x19b)]()['toBuffer']();g=await l['broadcastPhoto']({'file':t});}i[C(0x1a2)]===D(0x1ad)&&(g=await l[C(0x1c1)]({'video':p})),logger_1[D(0x189)][D(0x1bf)](D(0x183));}[C(0x1b6),C(0x1b0)]['includes'](i['mediaType'])&&!i[D(0x188)]&&(g=await l['broadcastText'](i[D(0x18b)]),logger_1[D(0x189)][D(0x1bf)]('sendMessage\x20text'));const m={...i,...g,'id':i['id'],'timestamp':i['timestamp'],'messageId':g['item_id'],'status':C(0x1bc),'ack':0x2};await Message_1[C(0x1a4)][C(0x1ab)]({...m},{'where':{'id':i['id']}}),(0x0,socketEmit_1[C(0x1a4)])({'tenantId':j['tenantId'],'type':D(0x185),'payload':{...i[D(0x1a8)],'mediaUrl':i[D(0x18c)],'id':i['id'],'timestamp':i[C(0x1a9)],'messageId':g[D(0x18d)],'status':'sended','ack':0x2}}),logger_1[D(0x189)]['info'](C(0x187)),await(0x0,sleepRandomTime_1[D(0x1b8)])({'minMilliseconds':Number(0x7d0),'maxMilliseconds':Number(0xbb8)});}catch(u){const v=i['id'],w=i[D(0x186)]['id'];logger_1[D(0x189)]['error'](C(0x196)+d+C(0x19c)+w+')'),logger_1[D(0x189)][C(0x19a)](D(0x1ae)+v+')::\x20'+u);}}};exports[B(0x1a4)]=SendMessagesSystemWbot;