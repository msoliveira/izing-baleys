'use strict';const s=b,u=b;(function(c,d){const q=b,r=b,e=c();while(!![]){try{const f=parseInt(q(0x15b))/0x1+parseInt(r(0x15f))/0x2+parseInt(q(0x168))/0x3+-parseInt(q(0x18f))/0x4*(-parseInt(r(0x16a))/0x5)+-parseInt(r(0x17a))/0x6*(-parseInt(r(0x152))/0x7)+parseInt(r(0x161))/0x8*(parseInt(q(0x15e))/0x9)+-parseInt(r(0x166))/0xa;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xb7f83));var __importDefault=this&&this[s(0x15c)]||function(c){const t=s;return c&&c[t(0x16e)]?c:{'default':c};};function b(c,d){const e=a();return b=function(f,g){f=f-0x144;let h=e[f];return h;},b(c,d);}Object[u(0x17e)](exports,s(0x16e),{'value':!![]});const socketEmit_1=__importDefault(require(u(0x196))),CreateMessageSystemService_1=__importDefault(require(s(0x165))),CreateLogTicketService_1=__importDefault(require(u(0x18a))),BuildSendMessageService_1=__importDefault(require(s(0x145))),DefinedUserBotService_1=__importDefault(require('./DefinedUserBotService')),IsContactTest_1=__importDefault(require(u(0x163))),VerifyContactBaileys_1=require(s(0x179)),VerifyMensageOpenIAQueue_1=__importDefault(require(u(0x14b))),Queue_1=__importDefault(require(u(0x186))),SetTicketMessagesAsRead_1=__importDefault(require(s(0x14a))),isNextSteps=async(c,d,e,f)=>{const v=u,w=u;if(f[v(0x18e)]===0x0){await c[v(0x18d)]({'stepChatFlow':f[v(0x169)],'botRetries':0x0,'lastInteractionBot':new Date()});const g=[...d['flow'][v(0x176)]],h=g[v(0x170)](i=>i['id']===f[w(0x169)]);if(!h)return;for(const i of h[w(0x181)]){if(v(0x156)!=='pvZPo')return![];else await(0x0,BuildSendMessageService_1[v(0x195)])({'msg':i,'tenantId':c[w(0x157)],'ticket':c});}await(0x0,SetTicketMessagesAsRead_1['default'])(c);}},isQueueDefine=async(c,d,e,f)=>{const x=s,y=u;if(f[x(0x18e)]===0x1){c['update']({'queueId':f[x(0x184)],'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'lastInteractionBot':new Date()}),await(0x0,CreateLogTicketService_1[x(0x195)])({'ticketId':c['id'],'type':y(0x187),'queueId':f['queueId']});d?.[x(0x17f)]?.['autoDistributeTickets']&&(y(0x173)!==y(0x147)?(await(0x0,DefinedUserBotService_1['default'])(c,f[y(0x184)],c[y(0x157)],d?.[y(0x17f)]?.[x(0x158)]),c[x(0x192)]()):e=f[x(0x171)][x(0x153)](/\s/g,''));(0x0,socketEmit_1[x(0x195)])({'tenantId':c[x(0x157)],'type':y(0x177),'payload':c});const g=await Queue_1[y(0x195)][y(0x150)](f['queueId']);if(g[y(0x178)]){if(x(0x162)!==y(0x162))return g(h)['toLowerCase']()[y(0x18b)]()===i(j)['toLowerCase']()[x(0x18b)]();else await c[x(0x18d)]({'is_chat_ia':!![]});}await(0x0,VerifyMensageOpenIAQueue_1[y(0x195)])(c,g,!![],!![]);}},isUserDefine=async(c,d,e)=>{const z=s,A=u;e[z(0x18e)]===0x2&&(await c[A(0x18d)]({'userId':e[A(0x15a)],'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'is_chat_ia':![],'lastInteractionBot':new Date()}),await c[z(0x192)](),await(0x0,CreateLogTicketService_1[z(0x195)])({'userId':e[z(0x15a)],'ticketId':c['id'],'type':A(0x17d)}),(0x0,socketEmit_1['default'])({'tenantId':c[z(0x157)],'type':z(0x177),'payload':c}));},sendWelcomeMessage=async(c,d)=>{const B=s,C=u;if(d?.[B(0x17f)]?.[B(0x154)]?.['message']){if(C(0x151)==='cXgiY')g['userId']=h,i[B(0x16f)]=j;else{const f={'body':d['configurations']?.['welcomeMessage'][C(0x182)],'fromMe':!![],'read':!![],'sendType':C(0x17c)};await(0x0,CreateMessageSystemService_1[C(0x195)])({'msg':f,'tenantId':c[B(0x157)],'ticket':c,'sendType':f['sendType'],'status':C(0x160)});}}},isRetriesLimit=async(c,d)=>{const D=u,E=s,e=d?.[D(0x17f)]?.[E(0x14e)]?.['number'];if(d?.[D(0x17f)]?.['maxRetryBotMessage']&&e&&c[D(0x146)]>=e-0x1){const f=d[E(0x17f)][D(0x14e)][E(0x148)],{destiny:g}=d[E(0x17f)][D(0x14e)],h={'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'lastInteractionBot':new Date()},i={'ticketId':c['id'],'type':f===0x1?E(0x16c):E(0x175)};return f===0x1&&(h[D(0x184)]=g,i[D(0x184)]=g),f===0x2&&(h['userId']=g,i['userId']=g),c[D(0x18d)](h),(0x0,socketEmit_1[D(0x195)])({'tenantId':c['tenantId'],'type':D(0x177),'payload':c}),await(0x0,CreateLogTicketService_1[E(0x195)])(i),await sendWelcomeMessage(c,d),!![];}return![];},isAnswerCloseTicket=async(c,d,e)=>{const F=s,G=u;if(!c?.['configurations']?.[F(0x14c)]||c?.[F(0x17f)]?.[G(0x14c)]?.[G(0x155)]<0x1){if(F(0x14f)==='csMMl')g['queueId']=h,i[G(0x184)]=j;else return![];}const f=c[F(0x17f)][F(0x14c)][F(0x170)](h=>{const H=G,I=F;return String(h)[H(0x180)]()[H(0x18b)]()===String(e)[H(0x180)]()['trim']();});if(f)return F(0x188)!==F(0x194)?(await d[F(0x18d)]({'chatFlowId':null,'stepChatFlow':null,'botRetries':0x0,'lastInteractionBot':new Date(),'unreadMessages':0x0,'answered':![],'status':F(0x190)}),await(0x0,CreateLogTicketService_1[G(0x195)])({'ticketId':d['id'],'type':F(0x15d)}),(0x0,socketEmit_1['default'])({'tenantId':d[G(0x157)],'type':G(0x177),'payload':d}),!![]):g&&h[G(0x16e)]?i:{'default':j};return![];},VerifyStepsChatFlowTicket=async(c,d)=>{const J=s,K=u;let e;if(d['chatFlowId']&&d[J(0x191)]==='pending'&&!c[J(0x16b)]['fromMe']&&!d['isGroup']&&!d[K(0x16d)]){if(d[K(0x193)]){const f=await d[K(0x18c)]();f[J(0x171)]&&(e=f[J(0x171)][J(0x153)](/\s/g,''));const g=f['flow'][K(0x176)][J(0x170)](k=>k['id']===d[K(0x172)]),h=f['flow']['nodeList'][J(0x170)](k=>k['type']===J(0x17f)),i=await(0x0,VerifyContactBaileys_1[J(0x149)])(c),j=g['conditions'][K(0x170)](k=>{const L=J,M=J;if(k[L(0x148)]==='US')return!![];const l=k['condition'][M(0x174)](n=>String(n)[M(0x180)]()[L(0x18b)]()),m=String(i)[L(0x180)]()[M(0x18b)]();return l[L(0x185)](m);});if(!d['isCreated']&&await isAnswerCloseTicket(h,d,i))return;if(j&&!d[K(0x164)]){if(await(0x0,IsContactTest_1[K(0x195)])(d[J(0x189)]['number'],e,d[K(0x183)]))return;await isNextSteps(d,f,g,j),await isQueueDefine(d,h,g,j),await isUserDefine(d,g,j),(0x0,socketEmit_1[K(0x195)])({'tenantId':d[K(0x157)],'type':K(0x177),'payload':d});if(j['action']===0x1||j[J(0x18e)]===0x2){if(K(0x17b)!==J(0x17b)){if(h[J(0x148)]==='US')return!![];const l=i[J(0x159)][J(0x174)](p=>l(p)[J(0x180)]()[J(0x18b)]()),o=k(l)['toLowerCase']()[J(0x18b)]();return l[J(0x185)](o);}else await sendWelcomeMessage(d,h);}}else{if(await(0x0,IsContactTest_1[J(0x195)])(d[K(0x189)][J(0x144)],e,d[K(0x183)]))return;if(!d[J(0x164)]){if(await isRetriesLimit(d,h))return;const l={'body':h['configurations'][K(0x167)][J(0x182)]||'Desculpe!\x20Não\x20entendi\x20sua\x20resposta.\x20Vamos\x20tentar\x20novamente!\x20Escolha\x20uma\x20opção\x20válida.','fromMe':!![],'read':!![],'sendType':'bot'};await(0x0,CreateMessageSystemService_1[K(0x195)])({'msg':l,'tenantId':d[K(0x157)],'ticket':d,'sendType':l[K(0x14d)],'status':J(0x160)}),await d[K(0x18d)]({'botRetries':d['botRetries']+0x1,'lastInteractionBot':new Date()});}for(const m of g['interactions']){await(0x0,BuildSendMessageService_1['default'])({'msg':m,'tenantId':d[J(0x157)],'ticket':d});}}await(0x0,SetTicketMessagesAsRead_1[K(0x195)])(d);}}};exports[s(0x195)]=VerifyStepsChatFlowTicket;function a(){const N=['pending','16audSMG','rXNQK','./IsContactTest','isCreated','../MessageServices/CreateMessageSystemService','47092410GyjjUk','notOptionsSelectMessage','3725877FgVmxj','nextStepId','3008455gKCDBv','key','retriesLimitQueue','answered','__esModule','userId','find','celularTeste','stepChatFlow','rrKML','map','retriesLimitUserDefine','nodeList','ticket:update','from_ia','../WbotServices/helpers/VerifyContactBaileys','12fllITN','FoOdy','bot','userDefine','defineProperty','configurations','toLowerCase','interactions','message','channel','queueId','includes','./../../models/Queue','queue','UMegb','contact','../TicketServices/CreateLogTicketService','trim','getChatFlow','update','action','4BpSUOX','closed','status','reload','chatFlowId','aCEOq','default','../../helpers/socketEmit','number','./BuildSendMessageService','botRetries','GVAIZ','type','getBodyMessage','../../helpers/SetTicketMessagesAsRead','../OpenIA/VerifyMensageOpenIAQueue','answerCloseTicket','sendType','maxRetryBotMessage','ufoSt','findByPk','wmOgF','3957667HyBPsf','replace','welcomeMessage','length','pvZPo','tenantId','autoDistributeTickets','condition','userIdDestination','753472xyeSOt','__importDefault','autoClose','5073948pGIBVQ','1214704LujfED'];a=function(){return N;};return a();}