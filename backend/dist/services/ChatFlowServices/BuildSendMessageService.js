'use strict';const q=b,s=b;(function(c,d){const o=b,p=b,e=c();while(!![]){try{const f=-parseInt(o(0x120))/0x1*(parseInt(o(0x122))/0x2)+parseInt(o(0x11f))/0x3+parseInt(o(0x119))/0x4+-parseInt(o(0x128))/0x5+-parseInt(o(0x111))/0x6*(parseInt(o(0x12b))/0x7)+parseInt(p(0x10b))/0x8+-parseInt(o(0x11c))/0x9*(-parseInt(o(0x127))/0xa);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xa969f));function b(c,d){const e=a();return b=function(f,g){f=f-0x10a;let h=e[f];return h;},b(c,d);}var __importDefault=this&&this[q(0x10d)]||function(c){const r=q;return c&&c[r(0x133)]?c:{'default':c};};Object[s(0x134)](exports,'__esModule',{'value':!![]});const pupa_1=require(q(0x116)),logger_1=require(q(0x12c)),Ticket_1=__importDefault(require('../../models/Ticket')),Message_1=__importDefault(require(q(0x125))),socketEmit_1=__importDefault(require('../../helpers/socketEmit')),queueValidation_1=__importDefault(require('../../utils/queueValidation')),BuildSendMessageService=async({msg:c,tenantId:d,ticket:e,userId:f})=>{const t=q,u=s,g={'ticketId':e['id'],'body':'','contactId':e['contactId'],'fromMe':!![],'read':!![],'mediaType':t(0x12a),'mediaUrl':undefined,'timestamp':new Date()['getTime'](),'quotedMsgId':undefined,'userId':f,'scheduleDate':undefined,'sendType':u(0x12e),'status':u(0x10e),'tenantId':d};try{if(c[u(0x10c)]===t(0x11a)&&c['data'][u(0x130)]){const h=c[t(0x123)][u(0x130)][t(0x112)]('/'),i={...g,'body':c[t(0x123)][t(0x11b)],'mediaUrl':h[h[t(0x115)]-0x1],'mediaType':c[u(0x123)][u(0x10c)]?c[t(0x123)]?.[u(0x10c)][u(0x121)](0x0,c[t(0x123)][u(0x10c)]['indexOf']('/')):t(0x12a)},j=await Message_1[u(0x10f)][t(0x12f)](i),k=await Message_1[t(0x10f)][t(0x118)](j['id'],{'include':[{'model':Ticket_1[t(0x10f)],'as':u(0x117),'where':{'tenantId':d},'include':[u(0x113)]},{'model':Message_1['default'],'as':'quotedMsg','include':[t(0x113)]}]});if(!k)throw new Error(u(0x11d));await e['update']({'lastMessage':k[u(0x10a)],'lastMessageAt':new Date()['getTime']()}),await(0x0,queueValidation_1[u(0x10f)])(e[t(0x114)],e['tenantId'],[k]),(0x0,socketEmit_1[u(0x10f)])({'tenantId':d,'type':u(0x124),'payload':k});}else{c[t(0x123)]['message']=(0x0,pupa_1['pupa'])(c[t(0x123)][t(0x12d)]||'',{'protocol':e[t(0x126)],'name':e[t(0x113)][t(0x11b)]});const l=await Message_1[u(0x10f)][t(0x12f)]({...g,'body':c['data'][t(0x12d)],'mediaType':'chat'}),m=await Message_1['default'][u(0x118)](l['id'],{'include':[{'model':Ticket_1['default'],'as':t(0x117),'where':{'tenantId':d},'include':[u(0x113)]},{'model':Message_1[t(0x10f)],'as':'quotedMsg','include':['contact']}]});if(!m)throw new Error('ERR_CREATING_MESSAGE_SYSTEM');await e[t(0x132)]({'lastMessage':m[u(0x10a)],'lastMessageAt':new Date()[t(0x129)](),'answered':!![]}),await(0x0,queueValidation_1[u(0x10f)])(e[t(0x114)],e[t(0x131)],[m]),(0x0,socketEmit_1[u(0x10f)])({'tenantId':d,'type':t(0x124),'payload':m});}}catch(n){logger_1[u(0x110)]['error'](t(0x11e),n);}};exports[s(0x10f)]=BuildSendMessageService;function a(){const v=['52igSwsk','data','chat:create','../../models/Message','protocol','210sSCkTM','3417085nnLMnK','getTime','chat','119AALHcj','../../utils/logger','message','bot','create','mediaUrl','tenantId','update','__esModule','defineProperty','body','11099624ywldcK','type','__importDefault','pending','default','logger','177234WaHTvm','split','contact','whatsappId','length','../../utils/pupa','ticket','findByPk','985528pxPVFL','MediaField','name','294642mLZwSG','ERR_CREATING_MESSAGE_SYSTEM','BuildSendMessageService','731514CItSeq','26372ZJjJNG','substr'];a=function(){return v;};return a();}