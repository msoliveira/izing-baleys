'use strict';function a(){const v=['bot','indexOf','update','../../models/Message','type','ticket','chat:create','10DeVDLH','split','body','BuildSendMessageService','default','1391200cXzdUN','substr','contactId','whatsappId','logger','chat','create','../../models/Ticket','../../utils/queueValidation','findByPk','898044IPGRuw','3022443pgOfnz','name','__importDefault','../../utils/logger','getTime','__esModule','864105EpdvwB','MediaField','length','message','data','pending','30opIVsz','pupa','error','808864ktqocs','48853IwRAoJ','mediaUrl','quotedMsg','defineProperty','contact','58411TenCzP','tenantId','ERR_CREATING_MESSAGE_SYSTEM'];a=function(){return v;};return a();}const q=b,s=b;(function(c,d){const o=b,p=b,e=c();while(!![]){try{const f=parseInt(o(0xb7))/0x1*(parseInt(o(0x92))/0x2)+-parseInt(o(0xa1))/0x3+-parseInt(p(0xb1))/0x4+-parseInt(o(0xa8))/0x5+parseInt(p(0xae))/0x6*(parseInt(o(0xb2))/0x7)+parseInt(o(0x97))/0x8+parseInt(p(0xa2))/0x9;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x279f4));var __importDefault=this&&this[q(0xa4)]||function(c){const r=q;return c&&c[r(0xa7)]?c:{'default':c};};Object[s(0xb5)](exports,s(0xa7),{'value':!![]});const pupa_1=require('../../utils/pupa'),logger_1=require(s(0xa5)),Ticket_1=__importDefault(require(s(0x9e))),Message_1=__importDefault(require(q(0xbd))),socketEmit_1=__importDefault(require('../../helpers/socketEmit')),queueValidation_1=__importDefault(require(s(0x9f))),BuildSendMessageService=async({msg:c,tenantId:d,ticket:e,userId:f})=>{const t=q,u=s,g={'ticketId':e['id'],'body':'','contactId':e[t(0x99)],'fromMe':!![],'read':!![],'mediaType':u(0x9c),'mediaUrl':undefined,'timestamp':new Date()[t(0xa6)](),'quotedMsgId':undefined,'userId':f,'scheduleDate':undefined,'sendType':u(0xba),'status':t(0xad),'tenantId':d};try{if(c[u(0xbe)]===u(0xa9)&&c[t(0xac)][t(0xb3)]){const h=c[u(0xac)][u(0xb3)][t(0x93)]('/'),i={...g,'body':c['data'][t(0xa3)],'mediaUrl':h[h[u(0xaa)]-0x1],'mediaType':c[u(0xac)][u(0xbe)]?c[u(0xac)]?.[t(0xbe)][t(0x98)](0x0,c[u(0xac)][t(0xbe)][u(0xbb)]('/')):u(0x9c)},j=await Message_1['default'][t(0x9d)](i),k=await Message_1[t(0x96)][t(0xa0)](j['id'],{'include':[{'model':Ticket_1[u(0x96)],'as':u(0xbf),'where':{'tenantId':d},'include':[u(0xb6)]},{'model':Message_1[t(0x96)],'as':t(0xb4),'include':[u(0xb6)]}]});if(!k)throw new Error(u(0xb9));await e[t(0xbc)]({'lastMessage':k[u(0x94)],'lastMessageAt':new Date()[t(0xa6)]()}),await(0x0,queueValidation_1[u(0x96)])(e[t(0x9a)],e[t(0xb8)],[k]),(0x0,socketEmit_1['default'])({'tenantId':d,'type':u(0x91),'payload':k});}else{c[t(0xac)]['message']=(0x0,pupa_1[u(0xaf)])(c[u(0xac)][u(0xab)]||'',{'protocol':e['protocol'],'name':e[t(0xb6)][t(0xa3)]});const l=await Message_1[u(0x96)][u(0x9d)]({...g,'body':c[u(0xac)]['message'],'mediaType':u(0x9c)}),m=await Message_1[u(0x96)][u(0xa0)](l['id'],{'include':[{'model':Ticket_1['default'],'as':'ticket','where':{'tenantId':d},'include':[t(0xb6)]},{'model':Message_1[u(0x96)],'as':t(0xb4),'include':[u(0xb6)]}]});if(!m)throw new Error('ERR_CREATING_MESSAGE_SYSTEM');await e[t(0xbc)]({'lastMessage':m[u(0x94)],'lastMessageAt':new Date()[t(0xa6)](),'answered':!![]}),await(0x0,queueValidation_1['default'])(e[t(0x9a)],e[t(0xb8)],[m]),(0x0,socketEmit_1[t(0x96)])({'tenantId':d,'type':u(0x91),'payload':m});}}catch(n){logger_1[t(0x9b)][u(0xb0)](u(0x95),n);}};function b(c,d){const e=a();return b=function(f,g){f=f-0x91;let h=e[f];return h;},b(c,d);}exports[q(0x96)]=BuildSendMessageService;