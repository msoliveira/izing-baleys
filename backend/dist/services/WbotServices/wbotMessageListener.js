'use strict';const N=b,V=b;(function(c,d){const L=b,M=b,e=c();while(!![]){try{const f=parseInt(L(0x252))/0x1+parseInt(M(0x1fd))/0x2*(-parseInt(L(0x215))/0x3)+parseInt(M(0x246))/0x4+parseInt(M(0x245))/0x5+-parseInt(L(0x22a))/0x6*(parseInt(L(0x1dd))/0x7)+parseInt(M(0x25e))/0x8+-parseInt(L(0x229))/0x9*(parseInt(M(0x1da))/0xa);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x22df7));function b(c,d){const e=a();return b=function(f,g){f=f-0x1ca;let h=e[f];return h;},b(c,d);}function a(){const al=['farewellMessage','../../models/Setting','../../libs/cache','ticket','queueId','../QueueServices/GetQueueService','WebHooksAPI','bnyLD','contacts:','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20c.\x22tenantId\x22\x20=\x20','Vfpoo','YhDHS','participant','@sentry/node','answered','Error\x20handling\x20message\x20ack.\x20Err:\x20','../../models/Message','oHGVN','ISmDo','2xWUmUS','length','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20c.\x22number\x22\x20=\x20\x27','hNoQC','SELECT','messages','QueryTypes','key','broadcast','receiptTimestamp','BFNCk','fromMe','forEach','Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20','is_chat_ia','VerifyContactBaileys','messages.update','findOne','@g.us','quotedMessage','WAMessageStubType','__importStar','./helpers/VerifyContactBaileys','getOwnPropertyDescriptor','745305KhmzXI','E2E_IDENTITY_CHANGED','getBodyMessage','apiConfig','videoMessage','create','isValidBaileys','status','mAgAD','documentMessage','get','select\x20t.id,\x20t.\x22lastMessage\x22,\x20c.\x22number\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x20t,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22Contacts\x22\x20c\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20t.\x22tenantId\x22\x20=\x20','defineProperty','./helpers/IsValidMsg','imageMessage','stringify','\x27\x20and\x20c.\x22tenantId\x22\x20=\x20','value','logger','KUGWF','9kYCTyT','52278YlZwJw','contact','shift','tyEOq','hriRO','GbHFG','externalKey','ksBbo','@whiskeysockets/baileys','UpaBA','update','lKbWk','profilePictureUrl','sequelize','REVOKE','nyTYN','KKDbz','call','test','isFarewellMessage','isCampaignMessage','split','MMbUQ','E2E_DEVICE_CHANGED','configurable','../../utils/logger','receipt','48405SMZiCV','155612xCXLJa','image','count','message-receipt.update','tenantId','quotedMsg','aiKxT','../../helpers/socketEmit','type','../OpenIA/VerifyMensageOpenIAQueue','../TicketServices/FindOrCreateTicketService','contextInfo','277658KnJidY','./helpers/VerifyBusinessHours','urlMessageStatus','message','VerifyMediaMessageBaileys','default','CIPHERTEXT','includes','prototype',':unreads','writable','query','1826264LeylbZ','error','../ChatFlowServices/VerifyStepsChatFlowTicket','DmtTT','messageStubType','groupMetadata','bkPhN','bpBIr','\x20and\x20c.\x22number\x22\x20=\x20\x27','remoteJid','whatsapp','zrVkN','hookMessage','set','captureException','extendedTextMessage','FCSxi','add','__esModule','412690HBuCiC','lrIzP','hasOwnProperty','98cOuVQn','cacheLayer','indexOf','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20t.\x22contactId\x22\x20=\x20c.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20t.id\x20=\x20(select\x20max(id)\x20from\x20\x22Tickets\x22\x20where\x20t.\x22tenantId\x22\x20=\x20','XDTvC','map','protocolMessage','readTimestamp','now','wbotMessageListenerBaileys','filter','../WhatsappService/ShowWhatsAppService','jSvtg'];a=function(){return al;};return a();}var __createBinding=this&&this['__createBinding']||(Object[N(0x21a)]?function(c,d,e,f){const O=N,P=N;if(f===undefined)f=e;var g=Object[O(0x214)](d,e);(!g||(O(0x21f)in g?!d[P(0x1d9)]:g[P(0x25c)]||g[P(0x242)]))&&(g={'enumerable':!![],'get':function(){const Q=O,R=P;if(Q(0x22e)===Q(0x22e))return d[e];else{if(e===l)d=n;c[p]=q[r];}}}),Object['defineProperty'](c,f,g);}:function(c,d,e,f){if(f===undefined)f=e;c[f]=d[e];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(c,d){const S=N,T=N;Object[S(0x221)](c,S(0x257),{'enumerable':!![],'value':d});}:function(c,d){const U=N;c[U(0x257)]=d;}),__importStar=this&&this[V(0x212)]||function(c){const W=V,X=N;if(c&&c[W(0x1d9)])return c;var d={};if(c!=null){for(var e in c)if(e!==W(0x257)&&Object[X(0x25a)]['hasOwnProperty']['call'](c,e))__createBinding(d,c,e);}return __setModuleDefault(d,c),d;},__importDefault=this&&this['__importDefault']||function(c){return c&&c['__esModule']?c:{'default':c};};Object[N(0x221)](exports,V(0x1d9),{'value':!![]}),exports[N(0x1e6)]=void 0x0;const baileys_1=require(N(0x232)),Message_1=__importDefault(require(V(0x1fa))),Sentry=__importStar(require(N(0x1f7))),logger_1=require(V(0x243)),Ticket_1=__importDefault(require('../../models/Ticket')),IsValidMsg_1=require(N(0x222)),ShowWhatsAppService_1=__importDefault(require(V(0x1e8))),Setting_1=__importDefault(require(V(0x1eb))),FindOrCreateTicketService_1=__importDefault(require(V(0x250))),VerifyContactBaileys_1=require(N(0x213)),Queue_1=__importDefault(require('../../libs/Queue')),VerifyBusinessHours_1=__importDefault(require(V(0x253))),VerifyStepsChatFlowTicket_1=__importDefault(require(V(0x260))),socketEmit_1=__importDefault(require(V(0x24d))),index_1=__importDefault(require('./../../database/index')),sequelize_1=require(N(0x237)),CampaignContacts_1=__importDefault(require('../../models/CampaignContacts')),cache_1=require(N(0x1ec)),GetQueueService_1=__importDefault(require(V(0x1ef))),VerifyMensageOpenIAQueue_1=__importDefault(require(V(0x24f))),messageQueue=[],filterMessages=c=>{const Y=N,Z=N;if(c[Y(0x255)]?.[Z(0x1e3)])return![];if([baileys_1[Y(0x211)][Z(0x238)],baileys_1[Y(0x211)][Y(0x241)],baileys_1[Y(0x211)][Z(0x216)],baileys_1[Y(0x211)][Z(0x258)]]['includes'](c[Y(0x1cb)]))return![];return!![];},wbotMessageListenerBaileys=async(c,d)=>{const a2=N,a7=N;try{c['ev']['on']('messages.upsert',async e=>{const a0=b,a1=b,f=e[a0(0x202)][a1(0x1e7)](filterMessages)[a0(0x1e2)](g=>g);if(!f)return;for(let g of f){if('EQrKH'===a1(0x1e9))g[a1(0x1d5)](h),i[a1(0x227)][a0(0x25f)]('Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20'+j);else{const i=g[a0(0x204)]['remoteJid'][a0(0x23f)]('@')[0x0],j=a1(0x220)+d[a0(0x24a)]+a1(0x1ff)+i+a1(0x1f3)+d['tenantId']+a1(0x1e0)+d[a1(0x24a)]+a1(0x1cf)+i+a0(0x225)+d['tenantId']+')',k=await index_1[a1(0x257)]?.[a1(0x25d)](j,{'type':sequelize_1[a1(0x203)][a1(0x201)],'nest':!![]});if(k[a0(0x1fe)]>0x0&&g[a1(0x204)][a0(0x208)]&&k[0x0]['lastMessage']===d[a1(0x1ea)])return;const l=await CampaignContacts_1[a0(0x257)][a1(0x248)]({'where':{'messageId':g[a0(0x204)]['id']}});if(l>0x0){if(a0(0x233)==='IILGr'){if(i[a0(0x255)]?.[a1(0x1e3)])return![];if([j['WAMessageStubType'][a0(0x238)],k[a1(0x211)][a1(0x241)],l[a0(0x211)][a1(0x216)],m[a0(0x211)]['CIPHERTEXT']][a1(0x259)](n[a1(0x1cb)]))return![];return!![];}else return;}const m=await Message_1[a1(0x257)][a1(0x248)]({'where':{'messageId':g[a0(0x204)]['id'],'tenantId':d[a0(0x24a)]}});if(!m){const o=await(0x0,VerifyContactBaileys_1[a0(0x217)])(g),p=/\u200c/[a1(0x23c)](o);!p&&(a0(0x1f4)!==a1(0x240)?await handleMessageBaileys(c,g,d['id']):e=f[a1(0x234)][a0(0x21c)]);}else g[a0(0x204)][a0(0x208)]&&await Message_1[a0(0x257)][a0(0x234)]({'dataJson':JSON[a0(0x224)](g)},{'where':{'messageId':g['key']['id'],'tenantId':d[a0(0x24a)]}});}}}),c['ev']['on'](a2(0x20d),e=>{const a3=a2,a4=a2;if(a3(0x207)!==a3(0x22d)){if(e[a3(0x1fe)]===0x0)return;e[a3(0x209)](async f=>{const a5=a4,a6=a3;if('ZVDYT'!==a5(0x1ca)){let g;if(f[a6(0x234)][a5(0x21c)]===0x3&&f?.['key']?.['fromMe']){if(a6(0x1d2)==='zrVkN')g=0x2;else return;}else{if(a6(0x239)!==a6(0x239))return d[a5(0x204)][a6(0x1d0)]?.[a5(0x1df)](a5(0x20f))>0x0;else g=f[a5(0x234)][a5(0x21c)];}handleMsgAckBaileys(f,g);}else g[a5(0x1d5)](h),i[a5(0x227)][a5(0x25f)](a5(0x1f9)+j);});}else return;}),c['ev']['on'](a2(0x249),e=>{const a8=a2;e[a8(0x209)](async f=>{const a9=a8,aa=a8,g=f?.[a9(0x244)]?.[a9(0x206)]?0x3:f?.['receipt']?.[a9(0x1e4)]?0x4:0x0;if(!g)return;await handleMsgAckBaileys(f,g);});});}catch(e){a7(0x1f5)!==a7(0x1f5)?e[a2(0x257)]=f:(Sentry[a2(0x1d5)](e),logger_1[a2(0x227)][a2(0x25f)](a7(0x20a)+e));}};exports[V(0x1e6)]=wbotMessageListenerBaileys;const handleReceiveMessages=async()=>{const ab=N,ac=V;while(messageQueue[ab(0x1fe)]>0x0){if(ab(0x1ce)!=='bpBIr'){if(n&&o[ac(0x1d9)])return p;var d={};if(q!=null){for(var e in r)if(e!==ab(0x257)&&s[ab(0x25a)][ab(0x1dc)][ac(0x23b)](t,e))u(d,v,e);}return w(d,x),d;}else{const {message:d,wbot:e,whatsapp:f}=messageQueue[0x0];messageQueue[ac(0x22c)]();}}},handleMsgAckBaileys=async(c,d)=>{const ad=V,ae=V;await new Promise(e=>setTimeout(e,0x1f4));try{const e=await Message_1[ad(0x257)]['findOne']({'where':{'messageId':String(c[ad(0x204)]['id'])},'include':[ad(0x22b),{'model':Ticket_1[ad(0x257)],'as':ad(0x1ed)},{'model':Message_1['default'],'as':ae(0x24b),'include':[ae(0x22b)]}]});if(!e){if('gRWWV'==='IRzdR')return;else{const g=await CampaignContacts_1[ae(0x257)][ae(0x20e)]({'where':{'messageId':String(c[ad(0x204)]['id'])}});if(!g){if('vxogX'==='wVknX'){if(f[ad(0x1fe)]===0x0)return;g[ad(0x209)](async l=>{const af=ae,ag=ad;let m;l[af(0x234)][ag(0x21c)]===0x3&&l?.[af(0x204)]?.['fromMe']?m=0x2:m=l[ag(0x234)][ag(0x21c)],i(l,m);});}else return;}await g[ad(0x234)]({'ack':d});return;}}await e[ae(0x234)]({'ack':d}),(0x0,socketEmit_1[ae(0x257)])({'tenantId':e[ae(0x24a)],'type':'chat:ack','payload':e});}catch(i){'mAgAD'===ad(0x21d)?(Sentry[ae(0x1d5)](i),logger_1[ad(0x227)][ae(0x25f)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+i)):d=null;}},handleMessageBaileys=async(c,d,f)=>{const ah=N,ai=N;if(!(0x0,IsValidMsg_1[ah(0x21b)])(d)){if(ai(0x24c)===ai(0x24c))return;else e[ah(0x227)][ah(0x25f)](f);}const g=await(0x0,ShowWhatsAppService_1[ai(0x257)])({'id':f}),{tenantId:h,isDeleted:i}=g;if(i)return;const j=await Setting_1[ai(0x257)][ai(0x20e)]({'where':{'key':'ignoreGroupMsg','tenantId':h}});if(j?.[ai(0x226)]==='enabled'&&(isGroup(d)||d[ah(0x205)])){if('hNoQC'!==ai(0x200))return;else return;}try{if(ai(0x228)!==ai(0x228))while(f[ah(0x1fe)]>0x0){const {message:n,wbot:o,whatsapp:p}=i[0x0];j[ah(0x22c)]();}else{let n,o,p;if(!d[ai(0x204)]['fromMe'])try{if('FCSxi'===ai(0x1d7))o=await c['profilePictureUrl'](d[ah(0x204)]['remoteJid'],ah(0x247),0x7530);else{const {message:w,wbot:x,whatsapp:y}=e[0x0];f[ai(0x22c)]();}}catch(w){o=null;}let q={};if(isGroup(d)){if(ai(0x1f1)===ai(0x1f1))q=await c[ah(0x1cc)](d[ai(0x204)][ai(0x1d0)]),n=await(0x0,VerifyContactBaileys_1[ai(0x20c)])(d,h,o,!![],q);else return e[f];}if(!d[ai(0x204)]['fromMe'])try{if(d['key'][ai(0x1f6)]){if(ai(0x22f)===ah(0x23a)){const z={'timestamp':k[ah(0x1e5)](),'msg':l,'messageId':m[ai(0x204)]['id'],'ticketId':n['id'],'externalKey':o?.[ai(0x230)],'authToken':p?.['authToken'],'type':ah(0x1d3)};q['default'][ai(0x1d8)](ai(0x1f0),{'url':r['urlMessageStatus'],'type':z[ai(0x24e)],'payload':z});}else o=await c[ah(0x236)](d[ai(0x204)][ah(0x1f6)],'image',0x7530);}else o=await c[ah(0x236)](d['key'][ai(0x1d0)],'image',0x7530);}catch(z){if(ah(0x231)!==ah(0x231))return;else o=null;}p=await(0x0,VerifyContactBaileys_1[ai(0x20c)])(d,h,o,![],q);let r=0x0;if(d['key'][ai(0x208)])ah(0x1db)===ah(0x1db)?await cache_1[ai(0x1de)][ah(0x1d4)](ah(0x1f2)+p['id']+':unreads','0'):d=0x2;else{const C=await cache_1[ah(0x1de)][ah(0x21f)]('contacts:'+p['id']+ah(0x25b));r=+C+0x1,await cache_1[ai(0x1de)][ah(0x1d4)]('contacts:'+p['id']+ah(0x25b),''+r);}const s=await(0x0,FindOrCreateTicketService_1[ai(0x257)])({'contact':p,'whatsappId':f,'unreadMessages':r,'tenantId':h,'groupContact':n,'msg':d,'channel':ah(0x1d1)});if(s?.[ai(0x23e)])return;if(s?.[ah(0x23d)]){if(ah(0x1cd)===ah(0x1cd))return;else return;}if(d[ai(0x255)]?.[ah(0x223)]||d[ah(0x255)]?.['audioMessage']||d['message']?.['videoMessage']||d[ah(0x255)]?.['stickerMessage']||d[ai(0x255)]?.[ah(0x21e)]||d[ah(0x255)]?.['documentWithCaptionMessage']?.[ah(0x255)]?.[ai(0x21e)]||d[ai(0x255)]?.[ai(0x1d6)]?.[ah(0x251)]?.[ah(0x210)]?.[ah(0x223)]||d['message']?.[ah(0x1d6)]?.[ah(0x251)]?.[ah(0x210)]?.[ai(0x219)]){if(ai(0x1e1)==='tylzZ')return;else await(0x0,VerifyContactBaileys_1[ah(0x256)])(d,s,p);}else ai(0x235)!==ah(0x235)?f={'enumerable':!![],'get':function(){return i[j];}}:await(0x0,VerifyContactBaileys_1['VerifyMessageBaileys'])(d,d[ah(0x204)][ai(0x208)],s,p);const t=await(0x0,VerifyBusinessHours_1[ah(0x257)])(d,s);if(t)await(0x0,VerifyStepsChatFlowTicket_1[ai(0x257)])(d,s);if(t&&s[ai(0x1ee)]&&s[ah(0x20b)]){const G=await(0x0,GetQueueService_1['default'])(s[ah(0x1ee)]);await(0x0,VerifyMensageOpenIAQueue_1[ai(0x257)])(s,G,![],!![],d['key'],d);}const u=s[ah(0x218)]||{};if(!d[ai(0x204)]['fromMe']&&!s['isGroup']&&!s[ah(0x1f8)]&&u?.[ai(0x230)]&&u?.[ai(0x254)]){const H={'timestamp':Date['now'](),'msg':d,'messageId':d['key']['id'],'ticketId':s['id'],'externalKey':u?.[ah(0x230)],'authToken':u?.['authToken'],'type':ai(0x1d3)};Queue_1[ah(0x257)][ah(0x1d8)](ai(0x1f0),{'url':u['urlMessageStatus'],'type':H['type'],'payload':H});}}}catch(I){if(ai(0x1fb)===ah(0x1fc)){let K;h[ai(0x234)]['status']===0x3&&i?.['key']?.[ah(0x208)]?K=0x2:K=m[ai(0x234)][ai(0x21c)],k(l,K);}else logger_1[ah(0x227)][ai(0x25f)](I);}},isGroup=c=>{const aj=N,ak=V;return c[aj(0x204)]['remoteJid']?.[ak(0x1df)](aj(0x20f))>0x0;};