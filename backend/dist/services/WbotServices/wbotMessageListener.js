'use strict';const M=b,R=b;(function(c,d){const K=b,L=b,e=c();while(!![]){try{const f=parseInt(K(0x15a))/0x1+parseInt(K(0x172))/0x2+parseInt(K(0x1a1))/0x3*(-parseInt(L(0x15d))/0x4)+-parseInt(L(0x146))/0x5*(parseInt(K(0x1c2))/0x6)+-parseInt(L(0x162))/0x7+-parseInt(K(0x19d))/0x8*(parseInt(L(0x167))/0x9)+parseInt(L(0x17a))/0xa*(parseInt(L(0x1a7))/0xb);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xceda1));var __createBinding=this&&this[M(0x132)]||(Object['create']?function(c,d,e,f){const N=M,O=M;if(f===undefined)f=e;var g=Object['getOwnPropertyDescriptor'](d,e);if(!g||(N(0x14a)in g?!d[O(0x151)]:g[O(0x144)]||g['configurable'])){if('abVrN'!==N(0x158)){if(i[O(0x191)]?.[N(0x190)])return![];if([j[O(0x18d)][O(0x1b1)],e[O(0x18d)][N(0x18a)],l['WAMessageStubType'][O(0x19b)],d[N(0x18d)][O(0x149)]][O(0x1a3)](n[O(0x177)]))return![];return!![];}else g={'enumerable':!![],'get':function(){const P=O,Q=O;if(P(0x161)===P(0x13c)){const {message:j,wbot:l,whatsapp:n}=e[0x0];f[P(0x1c4)]();}else return d[e];}};}Object[O(0x179)](c,f,g);}:function(c,d,e,f){if(f===undefined)f=e;c[f]=d[e];}),__setModuleDefault=this&&this[M(0x16c)]||(Object[M(0x1ab)]?function(c,d){const S=M,T=M;Object[S(0x179)](c,S(0x1a5),{'enumerable':!![],'value':d});}:function(c,d){const U=R;c[U(0x1a5)]=d;}),__importStar=this&&this[R(0x155)]||function(c){const V=R,W=M;if(c&&c[V(0x151)])return c;var d={};if(c!=null){for(var e in c)if(e!==V(0x1a5)&&Object[V(0x18b)]['hasOwnProperty'][V(0x18f)](c,e))__createBinding(d,c,e);}return __setModuleDefault(d,c),d;},__importDefault=this&&this[M(0x156)]||function(c){return c&&c['__esModule']?c:{'default':c};};Object[M(0x179)](exports,M(0x151),{'value':!![]}),exports[M(0x1b6)]=void 0x0;function b(c,d){const e=a();return b=function(f,g){f=f-0x132;let h=e[f];return h;},b(c,d);}function a(){const ah=['../../utils/logger','documentWithCaptionMessage','hookMessage','status','4074TJefuT','set','shift','../WhatsappService/ShowWhatsAppService','enabled','length','\x20and\x20c.\x22number\x22\x20=\x20\x27','map','VsoYc','logger','__createBinding','indexOf','../QueueServices/GetQueueService','documentMessage','../ChatFlowServices/VerifyStepsChatFlowTicket','authToken','queueId','uAfuu','contextInfo','VerifyMediaMessageBaileys','SkPIZ','isGroup','FVHfP','sequelize','urlMessageStatus','profilePictureUrl','now','isFarewellMessage','writable','JIkyw','11695CuUGJi','qnJwY','update','CIPHERTEXT','get','lzDJP','groupMetadata','nGkiY','../../helpers/socketEmit','../TicketServices/FindOrCreateTicketService','../../libs/Queue','__esModule','select\x20t.id,\x20t.\x22lastMessage\x22,\x20c.\x22number\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x20t,\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x22Contacts\x22\x20c\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20t.\x22tenantId\x22\x20=\x20','audioMessage','nZbvD','__importStar','__importDefault','quotedMessage','abVrN','externalKey','328873nblhtT','receiptTimestamp',':unreads','4JAipEG','value','zeOSF','whatsapp','SyGLC','2896005imvAXO','answered','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20c.\x22number\x22\x20=\x20\x27','captureException','SELECT','18yCvnCk','./helpers/VerifyBusinessHours','message-receipt.update','extendedTextMessage','image','__setModuleDefault','../../models/Ticket','stringify','query','quotedMsg','iLYsO','2730582uHUNwQ','ticket','tenantId','@sentry/node','Error\x20handling\x20message\x20ack.\x20Err:\x20','messageStubType','count','defineProperty','11490440oJoTrw','GOqyv','Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20','@whiskeysockets/baileys','imageMessage','../../libs/cache','messages','ddspq','add','WebHooksAPI','chat:ack','error','lastMessage','QueryTypes','./helpers/VerifyContactBaileys','test','E2E_DEVICE_CHANGED','prototype','contacts:','WAMessageStubType','remoteJid','call','protocolMessage','message','findOne','./../../database/index','type','ignoreGroupMsg','BaLDm','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20c.\x22tenantId\x22\x20=\x20','jmyyu','fromMe','hasOwnProperty','E2E_IDENTITY_CHANGED','messages.upsert','4683544opgFxK','videoMessage','receipt','RjrtU','3363747gXdPvJ','iYKef','includes','forEach','default','filter','33Kljvzi','split','wZlSX','VerifyContactBaileys','create','qiLUs','\x27\x20and\x20c.\x22tenantId\x22\x20=\x20','isValidBaileys','TJKCy','twtqs','REVOKE','cacheLayer','key','participant','nfHJG','wbotMessageListenerBaileys','isCampaignMessage','OqKtu','getBodyMessage','yGkGW','GJfEo','contact','TOxrP'];a=function(){return ah;};return a();}const baileys_1=require(R(0x17d)),Message_1=__importDefault(require('../../models/Message')),Sentry=__importStar(require(R(0x175))),logger_1=require(R(0x1be)),Ticket_1=__importDefault(require(M(0x16d))),IsValidMsg_1=require('./helpers/IsValidMsg'),ShowWhatsAppService_1=__importDefault(require(M(0x1c5))),Setting_1=__importDefault(require('../../models/Setting')),FindOrCreateTicketService_1=__importDefault(require(R(0x14f))),VerifyContactBaileys_1=require(M(0x188)),Queue_1=__importDefault(require(M(0x150))),VerifyBusinessHours_1=__importDefault(require(M(0x168))),VerifyStepsChatFlowTicket_1=__importDefault(require(M(0x136))),socketEmit_1=__importDefault(require(M(0x14e))),index_1=__importDefault(require(M(0x193))),sequelize_1=require(R(0x13f)),CampaignContacts_1=__importDefault(require('../../models/CampaignContacts')),cache_1=require(M(0x17f)),GetQueueService_1=__importDefault(require(M(0x134))),VerifyMensageOpenIAQueue_1=__importDefault(require('../OpenIA/VerifyMensageOpenIAQueue')),messageQueue=[],filterMessages=c=>{const X=R,Y=M;if(c[X(0x191)]?.[X(0x190)])return![];if([baileys_1['WAMessageStubType'][Y(0x1b1)],baileys_1[Y(0x18d)]['E2E_DEVICE_CHANGED'],baileys_1[Y(0x18d)][X(0x19b)],baileys_1[Y(0x18d)][X(0x149)]][Y(0x1a3)](c[X(0x177)]))return![];return!![];},wbotMessageListenerBaileys=async(c,d)=>{const Z=R,a0=R;try{if('uOiWR'!==Z(0x196))c['ev']['on'](Z(0x19c),async e=>{const a1=Z,a2=a0,f=e[a1(0x180)][a2(0x1a6)](filterMessages)[a2(0x1c9)](g=>g);if(!f)return;for(let g of f){const h=g['key'][a2(0x18e)][a1(0x1a8)]('@')[0x0],i=a2(0x152)+d['tenantId']+a1(0x164)+h+a1(0x197)+d['tenantId']+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20t.\x22contactId\x22\x20=\x20c.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20and\x20t.id\x20=\x20(select\x20max(id)\x20from\x20\x22Tickets\x22\x20where\x20t.\x22tenantId\x22\x20=\x20'+d[a1(0x174)]+a1(0x1c8)+h+a1(0x1ad)+d['tenantId']+')',j=await index_1[a2(0x1a5)]?.[a1(0x16f)](i,{'type':sequelize_1[a1(0x187)][a2(0x166)],'nest':!![]});if(j[a2(0x1c7)]>0x0&&g['key']['fromMe']&&j[0x0][a2(0x186)]===d['farewellMessage'])return;const k=await CampaignContacts_1[a2(0x1a5)][a2(0x178)]({'where':{'messageId':g[a1(0x1b3)]['id']}});if(k>0x0)return;const l=await Message_1[a2(0x1a5)][a1(0x178)]({'where':{'messageId':g['key']['id'],'tenantId':d[a2(0x174)]}});if(!l){const m=await(0x0,VerifyContactBaileys_1[a2(0x1b9)])(g),n=/\u200c/[a1(0x189)](m);!n&&('BcXZO'!==a1(0x1a9)?await handleMessageBaileys(c,g,d['id']):(g['captureException'](h),i['logger'][a2(0x185)](a2(0x17c)+j)));}else g[a1(0x1b3)][a1(0x199)]&&await Message_1[a2(0x1a5)][a2(0x148)]({'dataJson':JSON[a2(0x16e)](g)},{'where':{'messageId':g[a1(0x1b3)]['id'],'tenantId':d[a2(0x174)]}});}}),c['ev']['on']('messages.update',e=>{const a3=Z,a4=Z;if(e[a3(0x1c7)]===0x0)return;e[a4(0x1a4)](async f=>{const a5=a4,a6=a3;let g;f[a5(0x148)][a5(0x1c1)]===0x3&&f?.[a6(0x1b3)]?.['fromMe']?a5(0x147)!==a6(0x1ac)?g=0x2:f[a5(0x179)](g,a5(0x1a5),{'enumerable':!![],'value':h}):g=f['update'][a5(0x1c1)],handleMsgAckBaileys(f,g);});}),c['ev']['on'](Z(0x169),e=>{const a7=Z;e[a7(0x1a4)](async f=>{const a8=a7,a9=a7;if(a8(0x145)==='JIkyw'){const g=f?.[a8(0x19f)]?.[a8(0x15b)]?0x3:f?.['receipt']?.['readTimestamp']?0x4:0x0;if(!g)return;await handleMsgAckBaileys(f,g);}else return;});});else return;}catch(f){'FVHfP'===Z(0x13e)?(Sentry[Z(0x165)](f),logger_1['logger']['error'](Z(0x17c)+f)):d=0x2;}};exports[M(0x1b6)]=wbotMessageListenerBaileys;const handleReceiveMessages=async()=>{const aa=M,ab=M;while(messageQueue[aa(0x1c7)]>0x0){if(ab(0x154)!=='nZbvD')return g&&h[aa(0x151)]?i:{'default':j};else{const {message:d,wbot:e,whatsapp:f}=messageQueue[0x0];messageQueue[ab(0x1c4)]();}}},handleMsgAckBaileys=async(c,d)=>{const ac=R,ad=R;await new Promise(e=>setTimeout(e,0x1f4));try{const e=await Message_1[ac(0x1a5)][ad(0x192)]({'where':{'messageId':String(c['key']['id'])},'include':[ad(0x1bc),{'model':Ticket_1['default'],'as':ac(0x173)},{'model':Message_1['default'],'as':ac(0x170),'include':[ad(0x1bc)]}]});if(!e){if(ac(0x1bd)===ac(0x15f)){if(n&&o['__esModule'])return p;var g={};if(q!=null){for(var h in r)if(h!==ac(0x1a5)&&s[ad(0x18b)][ac(0x19a)][ad(0x18f)](t,h))u(g,v,h);}return w(g,x),g;}else{const g=await CampaignContacts_1['default'][ad(0x192)]({'where':{'messageId':String(c['key']['id'])}});if(!g){if(ac(0x1b5)!==ad(0x14d))return;else return;}await g['update']({'ack':d});return;}}await e[ad(0x148)]({'ack':d}),(0x0,socketEmit_1[ac(0x1a5)])({'tenantId':e[ad(0x174)],'type':ac(0x184),'payload':e});}catch(i){Sentry[ad(0x165)](i),logger_1[ac(0x1cb)][ad(0x185)](ad(0x176)+i);}},handleMessageBaileys=async(c,d,f)=>{const ae=M,af=M;if(!(0x0,IsValidMsg_1[ae(0x1ae)])(d)){if(af(0x171)!==af(0x139))return;else d=null;}const g=await(0x0,ShowWhatsAppService_1['default'])({'id':f}),{tenantId:h,isDeleted:i}=g;if(i)return;const j=await Setting_1[af(0x1a5)][af(0x192)]({'where':{'key':af(0x195),'tenantId':h}});if(j?.[af(0x15e)]===af(0x1c6)&&(isGroup(d)||d['broadcast'])){if('GJfEo'===ae(0x1bb))return;else return;}try{if('RjrtU'===af(0x1a0)){let m,n,o;if(!d[ae(0x1b3)][af(0x199)]){if(af(0x14b)===af(0x1b8))e[af(0x1cb)][ae(0x185)](f);else try{n=await c[ae(0x141)](d[af(0x1b3)][ae(0x18e)],af(0x16b),0x7530);}catch(v){if(ae(0x1b0)!==ae(0x1b0))return;else n=null;}}let p={};isGroup(d)&&(p=await c[af(0x14c)](d['key'][ae(0x18e)]),m=await(0x0,VerifyContactBaileys_1[ae(0x1aa)])(d,h,n,!![],p));if(!d['key'][ae(0x199)]){if(ae(0x17b)===af(0x17b))try{if(d[ae(0x1b3)]['participant']){if(af(0x1ba)!=='yGkGW'){if(k===l)m=n;o[p]=q[r];}else n=await c[af(0x141)](d[af(0x1b3)][ae(0x1b4)],ae(0x16b),0x7530);}else n=await c[ae(0x141)](d[ae(0x1b3)][af(0x18e)],'image',0x7530);}catch(y){if(af(0x198)==='jmyyu')n=null;else return d[ae(0x1b3)][ae(0x18e)]?.[ae(0x133)]('@g.us')>0x0;}else e[ae(0x1a5)]=f;}o=await(0x0,VerifyContactBaileys_1[ae(0x1aa)])(d,h,n,![],p);let q=0x0;if(d['key']['fromMe']){if(ae(0x181)!==ae(0x181)){const C={'timestamp':k[ae(0x142)](),'msg':l,'messageId':m[af(0x1b3)]['id'],'ticketId':n['id'],'externalKey':o?.[af(0x159)],'authToken':p?.[ae(0x137)],'type':ae(0x1c0)};q[af(0x1a5)]['add'](af(0x183),{'url':r[af(0x140)],'type':C[ae(0x194)],'payload':C});}else await cache_1[ae(0x1b2)][af(0x1c3)](ae(0x18c)+o['id']+':unreads','0');}else{const C=await cache_1[af(0x1b2)][ae(0x14a)]('contacts:'+o['id']+af(0x15c));q=+C+0x1,await cache_1[af(0x1b2)][af(0x1c3)](ae(0x18c)+o['id']+af(0x15c),''+q);}const r=await(0x0,FindOrCreateTicketService_1[af(0x1a5)])({'contact':o,'whatsappId':f,'unreadMessages':q,'tenantId':h,'groupContact':m,'msg':d,'channel':ae(0x160)});if(r?.[ae(0x1b7)])return;if(r?.[af(0x143)])return;d[ae(0x191)]?.[ae(0x17e)]||d[ae(0x191)]?.[ae(0x153)]||d['message']?.[af(0x19e)]||d[af(0x191)]?.['stickerMessage']||d[ae(0x191)]?.[ae(0x135)]||d[ae(0x191)]?.[ae(0x1bf)]?.[ae(0x191)]?.['documentMessage']||d[af(0x191)]?.[ae(0x16a)]?.[ae(0x13a)]?.['quotedMessage']?.[ae(0x17e)]||d['message']?.['extendedTextMessage']?.[ae(0x13a)]?.[ae(0x157)]?.[ae(0x19e)]?'TJKCy'!==af(0x1af)?(g['captureException'](h),i[ae(0x1cb)][af(0x185)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+j)):await(0x0,VerifyContactBaileys_1[af(0x13b)])(d,r,o):await(0x0,VerifyContactBaileys_1['VerifyMessageBaileys'])(d,d[af(0x1b3)][af(0x199)],r,o);const s=await(0x0,VerifyBusinessHours_1[ae(0x1a5)])(d,r);if(s)await(0x0,VerifyStepsChatFlowTicket_1['default'])(d,r);if(s&&r[ae(0x138)]&&r['is_chat_ia']){if('mdEfM'!==ae(0x1ca)){const E=await(0x0,GetQueueService_1[ae(0x1a5)])(r[ae(0x138)]);await(0x0,VerifyMensageOpenIAQueue_1[ae(0x1a5)])(r,E,![],!![],d[ae(0x1b3)],d);}else d=null;}const t=r['apiConfig']||{};if(!d['key'][ae(0x199)]&&!r[ae(0x13d)]&&!r[af(0x163)]&&t?.['externalKey']&&t?.[af(0x140)]){const G={'timestamp':Date[af(0x142)](),'msg':d,'messageId':d[af(0x1b3)]['id'],'ticketId':r['id'],'externalKey':t?.[af(0x159)],'authToken':t?.[ae(0x137)],'type':'hookMessage'};Queue_1['default'][af(0x182)](af(0x183),{'url':t[af(0x140)],'type':G['type'],'payload':G});}}else e=f[ae(0x148)][af(0x1c1)];}catch(I){if(af(0x1a2)==='nQUXs')return;else logger_1[af(0x1cb)]['error'](I);}},isGroup=c=>{const ag=M;return c['key']['remoteJid']?.[ag(0x133)]('@g.us')>0x0;};