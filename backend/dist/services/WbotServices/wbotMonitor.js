'use strict';const I=b,N=b;function a(){const X=['terminate','4804263hRLiVP','defineProperty','default','hasOwnProperty','6kKFdQX','rejectCall','configurable','@sentry/node','call-creator','jlthX','293375lUqYnC','__esModule','sendMessage','logger','__setModuleDefault','42914gxvpOM','getOwnPropertyDescriptor','findOne','enabled','../../models/Setting','CoPOi','from','call','prototype','ZyLpj','writable','217848ChEWmw','attrs','content','key','1230232XQnRxw','replace','Chamada\x20de\x20voz/vídeo\x20perdida\x20às\x20','CB:call','value','rejectCalls','2990735TqyvdI','contacts.upsert','getMinutes','tag','27TnSMlf','../../models/Message','whatsapp','offer','../TicketServices/FindOrCreateTicketService','update','create','805OOIYgL','9582tDzCtv','error','get','captureException','../../utils/logger','call-id','40FhzYER'];a=function(){return X;};return a();}(function(c,d){const G=b,H=b,e=c();while(!![]){try{const f=parseInt(G(0x19f))/0x1*(parseInt(G(0x194))/0x2)+-parseInt(H(0x180))/0x3*(parseInt(G(0x1aa))/0x4)+parseInt(H(0x19a))/0x5+-parseInt(G(0x188))/0x6*(-parseInt(G(0x187))/0x7)+-parseInt(G(0x176))/0x8+-parseInt(H(0x190))/0x9+parseInt(H(0x18e))/0xa*(parseInt(H(0x17c))/0xb);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x44924));function b(c,d){const e=a();return b=function(f,g){f=f-0x173;let h=e[f];return h;},b(c,d);}var __createBinding=this&&this['__createBinding']||(Object[I(0x186)]?function(c,d,e,f){const J=I,K=I;if(f===undefined)f=e;var g=Object[J(0x1a0)](d,e);(!g||(J(0x18a)in g?!d['__esModule']:g[K(0x1a9)]||g[J(0x196)]))&&(g={'enumerable':!![],'get':function(){const L=J,M=K;if('CoPOi'!==L(0x1a4))g[M(0x18b)](h),i[L(0x19d)][M(0x189)](j);else return d[e];}}),Object[K(0x191)](c,f,g);}:function(c,d,e,f){if(f===undefined)f=e;c[f]=d[e];}),__setModuleDefault=this&&this[I(0x19e)]||(Object['create']?function(c,d){const O=N,P=I;Object[O(0x191)](c,P(0x192),{'enumerable':!![],'value':d});}:function(c,d){c['default']=d;}),__importStar=this&&this['__importStar']||function(c){const Q=I,R=I;if(c&&c[Q(0x19b)])return c;var d={};if(c!=null){for(var e in c)if(e!==Q(0x192)&&Object[R(0x1a7)][Q(0x193)][Q(0x1a6)](c,e))__createBinding(d,c,e);}return __setModuleDefault(d,c),d;},__importDefault=this&&this['__importDefault']||function(c){const S=N;return c&&c[S(0x19b)]?c:{'default':c};};Object[N(0x191)](exports,N(0x19b),{'value':!![]});const Sentry=__importStar(require(I(0x197))),Contact_1=__importDefault(require('../../models/Contact')),Setting_1=__importDefault(require(N(0x1a3))),logger_1=require(I(0x18c)),CreateOrUpdateBaileysService_1=__importDefault(require('../BaileysServices/CreateOrUpdateBaileysService')),FindOrCreateTicketService_1=__importDefault(require(N(0x184))),Message_1=__importDefault(require(I(0x181))),wbotMonitor=async(c,d,e)=>{const T=I,W=I;try{c['ws']['on'](T(0x179),async f=>{const U=T,V=T,g=f[U(0x174)][0x0];if(g[V(0x17f)]===V(0x183)){const h=await Setting_1['default']['findOne']({'where':{'key':V(0x17b),'tenantId':e}});if(h[V(0x17a)]===V(0x1a2)){if(U(0x199)!==U(0x1a8))c[V(0x195)](g[U(0x173)][U(0x18d)],g[V(0x173)][V(0x198)]);else{if(n&&o[V(0x19b)])return p;var j={};if(q!=null){for(var k in r)if(k!==U(0x192)&&s[U(0x1a7)][U(0x193)][U(0x1a6)](t,k))u(j,v,k);}return w(j,x),j;}}}if(g[V(0x17f)]===V(0x18f)){const j=await Setting_1[V(0x192)]['findOne']({'where':{'key':V(0x17b),'tenantId':e}});if(j['value']===V(0x1a2)){const k='As\x20chamadas\x20de\x20voz\x20e\x20vídeo\x20estão\x20desabilitas\x20para\x20esse\x20WhatsApp,\x20favor\x20enviar\x20uma\x20mensagem\x20de\x20texto.',l=await Setting_1[V(0x192)][V(0x1a1)]({'where':{'key':'callRejectMessage','tenantId':e}}),m=await c[U(0x19c)](f[V(0x173)][U(0x1a5)],{'text':l[U(0x17a)]||k}),n=f[U(0x173)][U(0x1a5)][U(0x177)](/\D/g,''),o=await Contact_1['default'][V(0x1a1)]({'where':{'tenantId':e,'number':n}}),p=await(0x0,FindOrCreateTicketService_1[U(0x192)])({'contact':o,'whatsappId':c['id'],'unreadMessages':0x1,'tenantId':e,'channel':V(0x182)}),q=new Date(),r=q['getHours'](),s=q[V(0x17e)](),t=V(0x178)+r+':'+s,u={'messageId':m[V(0x175)]['id'],'ticketId':p['id'],'contactId':o['id'],'body':t,'dataJson':m+'','fromMe':![],'mediaType':'call','read':!![],'quotedMsgId':null,'ack':0x1};await p[U(0x185)]({'lastMessage':t}),await Message_1['default'][V(0x186)]({...u,'tenantId':e});}}}),c['ev']['on'](T(0x17d),async f=>{await(0x0,CreateOrUpdateBaileysService_1['default'])({'whatsappId':d['id'],'contacts':f});});}catch(f){Sentry[T(0x18b)](f),logger_1[T(0x19d)]['error'](f);}};exports[N(0x192)]=wbotMonitor;