'use strict';const D=b,E=b;(function(c,d){const A=b,B=b,e=c();while(!![]){try{const f=parseInt(A(0x212))/0x1*(-parseInt(B(0x1f7))/0x2)+-parseInt(B(0x21e))/0x3+-parseInt(B(0x1fe))/0x4+parseInt(B(0x20d))/0x5+parseInt(A(0x1f9))/0x6+-parseInt(A(0x229))/0x7*(parseInt(B(0x1fa))/0x8)+parseInt(B(0x1ee))/0x9;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xe62ef));var __importDefault=this&&this['__importDefault']||function(c){const C=b;return c&&c[C(0x215)]?c:{'default':c};};Object[D(0x22d)](exports,E(0x215),{'value':!![]});const sequelize_1=require('sequelize'),Contact_1=__importDefault(require('../../models/Contact')),Ticket_1=__importDefault(require(E(0x221))),User_1=__importDefault(require(E(0x1ef))),ShowTicketService_1=__importDefault(require(D(0x21d))),CampaignContacts_1=__importDefault(require(D(0x227))),socketEmit_1=__importDefault(require(E(0x22e))),CheckChatBotFlowWelcome_1=__importDefault(require(D(0x1f2))),CreateLogTicketService_1=__importDefault(require(D(0x222))),Message_1=__importDefault(require(D(0x204))),ListSettingsService_1=__importDefault(require(E(0x226))),VerifyContactBaileys_1=require(E(0x205)),FindOrCreateTicketService=async({contact:c,whatsappId:d,unreadMessages:e,tenantId:f,groupContact:g,msg:h,isSync:i,channel:j})=>{const F=D,G=D;let k;if(j===F(0x214))k=h[F(0x228)];else{if(G(0x213)!==F(0x213)){const q=d[G(0x200)];return q[F(0x220)]=!![],q;}else k=h['key']['fromMe'];}if(j===G(0x210)&&h&&k){const q=await CampaignContacts_1['default'][F(0x20f)]({'where':{'contactId':c['id'],'messageId':h['key']?.['id']}});if(q?.['id']){if(G(0x209)==='JVkid')return{'isCampaignMessage':!![]};else e=f['fromMe'];}}if(h&&h[F(0x228)]){if(F(0x1f5)===G(0x1ed))return{'isCampaignMessage':!![]};else{const t=await Message_1['default'][G(0x20f)]({'where':{'messageId':h['key']?.['id']},'include':[F(0x200)]});if(t?.[F(0x200)]?.[G(0x208)]===G(0x224)&&t?.[F(0x200)]['lastMessage']===h['body']){const u=t[F(0x200)];return u[G(0x220)]=!![],u;}}}let l=await Ticket_1['default'][F(0x20f)]({'where':{'status':{[sequelize_1['Op']['or']]:[F(0x207),F(0x211)]},'tenantId':f,'whatsappId':d,'contactId':g?g['id']:c['id']},'include':[{'model':Contact_1[G(0x1f8)],'as':G(0x1fb),'include':['extraInfo',G(0x203),{'association':G(0x21a),'attributes':['id','name']}]},{'model':User_1['default'],'as':F(0x1fc),'attributes':['id','name']},{'association':G(0x210),'attributes':['id',F(0x218),'isDeleted']}]});if(l){if(G(0x206)!==F(0x216))return e=[F(0x20a),G(0x1eb),F(0x214),F(0x202)][G(0x21b)](j)&&e>0x0?e+=l['unreadMessages']:e,await l[G(0x1f0)]({'unreadMessages':e}),(0x0,socketEmit_1[G(0x1f8)])({'tenantId':f,'type':G(0x201),'payload':l}),l;else h['status']='open',i[G(0x223)]=j[0x0]['id'],k[F(0x22a)]=new l()['getTime']();}if(g){if(G(0x22c)!==F(0x22b)){l=await Ticket_1[F(0x1f8)][F(0x20f)]({'where':{'contactId':g['id'],'tenantId':f,'whatsappId':d},'order':[[F(0x1ec),'DESC']],'include':[{'model':Contact_1[G(0x1f8)],'as':F(0x1fb),'include':[G(0x21f),F(0x203),{'association':'wallets','attributes':['id',G(0x218)]}]},{'model':User_1['default'],'as':G(0x1fc),'attributes':['id',G(0x218)]},{'association':G(0x210),'attributes':['id',G(0x218),F(0x20c)]}]});if(l)return await l[F(0x1f0)]({'status':G(0x211),'userId':null,'unreadMessages':e}),(0x0,socketEmit_1['default'])({'tenantId':f,'type':'ticket:update','payload':l}),l;}else return g&&h[F(0x215)]?i:{'default':j};}else{l=await Ticket_1[G(0x1f8)][F(0x20f)]({'where':{'status':{[sequelize_1['Op']['in']]:[G(0x207),'pending']},'tenantId':f,'whatsappId':d,'contactId':c['id']},'order':[[F(0x1ec),G(0x217)]],'include':[{'model':Contact_1[F(0x1f8)],'as':F(0x1fb),'include':[F(0x21f),G(0x203),{'association':G(0x21a),'attributes':['id','name']}]},{'model':User_1['default'],'as':'user','attributes':['id',F(0x218)]},{'association':F(0x210),'attributes':['id',G(0x218),G(0x20c)]}]});if(l)return await l[F(0x1f0)]({'status':'pending','userId':null,'unreadMessages':e}),(0x0,socketEmit_1[F(0x1f8)])({'tenantId':f,'type':G(0x201),'payload':l}),l;}const m=(await(0x0,ListSettingsService_1[F(0x1f8)])(f))?.[F(0x1f4)](x=>x[F(0x1f1)]===G(0x20b))?.[G(0x1fd)]===F(0x1f3)||![],n={'contactId':g?g['id']:c['id'],'status':G(0x211),'isGroup':!!g,'unreadMessages':e,'whatsappId':d,'tenantId':f,'channel':j};if(m&&c['id']){const x=c,y=await x[F(0x21c)]();y&&y[0x0]?.['id']&&(n[F(0x208)]='open',n['userId']=y[0x0]['id'],n[G(0x22a)]=new Date()[F(0x1ff)]());}h&&('kEBZX'!=='cmXMa'?n[F(0x20e)]=await(0x0,VerifyContactBaileys_1['getBodyMessage'])(h):e=f['key']['fromMe']);const o=await Ticket_1[G(0x1f8)]['create'](n);return await(0x0,CreateLogTicketService_1[G(0x1f8)])({'ticketId':o['id'],'type':F(0x225)}),(j==='whatsapp'&&h&&!k||!o['userId']||i)&&await(0x0,CheckChatBotFlowWelcome_1[F(0x1f8)])(o),l=await(0x0,ShowTicketService_1[F(0x1f8)])({'id':o['id'],'tenantId':f}),l[F(0x219)](G(0x1f6),!![]),(0x0,socketEmit_1[G(0x1f8)])({'tenantId':f,'type':G(0x201),'payload':l}),l;};function b(c,d){const e=a();return b=function(f,g){f=f-0x1eb;let h=e[f];return h;},b(c,d);}function a(){const H=['waba','updatedAt','kLJRO','21922146dJDiCV','../../models/User','update','key','../../helpers/CheckChatBotFlowWelcome','enabled','find','rFjgT','isCreated','352DfbwXU','default','5427588hgvFHo','8DKXJQQ','contact','user','value','5939788TUusNa','getTime','ticket','ticket:update','messenger','tags','../../models/Message','../WbotServices/helpers/VerifyContactBaileys','QTUiy','open','status','JVkid','telegram','DirectTicketsToWallets','isDeleted','6318760MZrLxu','lastMessage','findOne','whatsapp','pending','3574EnWDNb','pdsBW','instagram','__esModule','gOwHv','DESC','name','setDataValue','wallets','includes','getWallets','./ShowTicketService','4559733mdpHGD','extraInfo','isFarewellMessage','../../models/Ticket','./CreateLogTicketService','userId','closed','create','../SettingServices/ListSettingsService','../../models/CampaignContacts','fromMe','192017GauPaE','startedAttendanceAt','wtFyi','xlxeP','defineProperty','../../helpers/socketEmit'];a=function(){return H;};return a();}exports[D(0x1f8)]=FindOrCreateTicketService;