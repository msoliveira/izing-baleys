'use strict';function b(c,d){const e=a();return b=function(f,g){f=f-0xc9;let h=e[f];return h;},b(c,d);}const v=b,x=b;(function(c,d){const t=b,u=b,e=c();while(!![]){try{const f=-parseInt(t(0xf0))/0x1+-parseInt(u(0xdd))/0x2+parseInt(u(0xf3))/0x3+parseInt(t(0xfe))/0x4*(-parseInt(u(0xd3))/0x5)+parseInt(t(0xe4))/0x6+parseInt(t(0xf5))/0x7+-parseInt(t(0xdb))/0x8*(-parseInt(t(0xfb))/0x9);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x90d31));function a(){const A=['includes','../../models/Contact','4229166DvoZVP','../../models/Ticket','isCreated','fromMe','pending','../../helpers/socketEmit','status','isFarewellMessage','whatsapp','./ShowTicketService','ticket','default','549665fbCYsc','__esModule','../SettingServices/ListSettingsService','48207BOrHgA','waba','3265689qDhjML','extraInfo','startedAttendanceAt','findOne','enabled','unreadMessages','90DYHKFw','lastMessage','updatedAt','2248264oGJQUe','key','ticket:update','user','messenger','defineProperty','update','getTime','getWallets','find','contact','name','./CreateLogTicketService','wallets','closed','5UgzPiz','../../models/User','isDeleted','open','../WbotServices/helpers/VerifyContactBaileys','../../models/Message','../../helpers/CheckChatBotFlowWelcome','userId','914152pkStmZ','__importDefault','1250430sMoleb','tags','sequelize','getBodyMessage','create'];a=function(){return A;};return a();}var __importDefault=this&&this[v(0xdc)]||function(c){const w=v;return c&&c[w(0xf1)]?c:{'default':c};};Object[x(0xc9)](exports,v(0xf1),{'value':!![]});const sequelize_1=require(v(0xdf)),Contact_1=__importDefault(require(v(0xe3))),Ticket_1=__importDefault(require(x(0xe5))),User_1=__importDefault(require(v(0xd4))),ShowTicketService_1=__importDefault(require(v(0xed))),CampaignContacts_1=__importDefault(require('../../models/CampaignContacts')),socketEmit_1=__importDefault(require(v(0xe9))),CheckChatBotFlowWelcome_1=__importDefault(require(x(0xd9))),CreateLogTicketService_1=__importDefault(require(v(0xd0))),Message_1=__importDefault(require(x(0xd8))),ListSettingsService_1=__importDefault(require(v(0xf2))),VerifyContactBaileys_1=require(x(0xd7)),FindOrCreateTicketService=async({contact:c,whatsappId:d,unreadMessages:e,tenantId:f,groupContact:g,msg:h,isSync:i,channel:j})=>{const y=v,z=x;if(h&&h['key'][y(0xe7)]){const o=await CampaignContacts_1[z(0xef)][y(0xf8)]({'where':{'contactId':c['id'],'messageId':h[z(0xff)]?.['id']}});if(o?.['id'])return{'isCampaignMessage':!![]};}if(h&&h[z(0xe7)]){const p=await Message_1[y(0xef)][z(0xf8)]({'where':{'messageId':h[y(0xff)]?.['id']},'include':['ticket']});if(p?.[z(0xee)]?.['status']===y(0xd2)&&p?.[y(0xee)][y(0xfc)]===h['body']){const q=p[z(0xee)];return q[y(0xeb)]=!![],q;}}let k=await Ticket_1[z(0xef)]['findOne']({'where':{'status':{[sequelize_1['Op']['or']]:[y(0xd6),'pending']},'tenantId':f,'whatsappId':d,'contactId':g?g['id']:c['id']},'include':[{'model':Contact_1['default'],'as':y(0xce),'include':[y(0xf6),y(0xde),{'association':y(0xd1),'attributes':['id','name']}]},{'model':User_1[y(0xef)],'as':'user','attributes':['id',z(0xcf)]},{'association':z(0xec),'attributes':['id',z(0xcf),z(0xd5)]}]});if(k)return e=['telegram',y(0xf4),'instagram',z(0x102)][z(0xe2)](j)&&e>0x0?e+=k[y(0xfa)]:e,await k[y(0xca)]({'unreadMessages':e}),(0x0,socketEmit_1['default'])({'tenantId':f,'type':z(0x100),'payload':k}),k;if(g){k=await Ticket_1[y(0xef)][z(0xf8)]({'where':{'contactId':g['id'],'tenantId':f,'whatsappId':d},'order':[[z(0xfd),'DESC']],'include':[{'model':Contact_1['default'],'as':z(0xce),'include':['extraInfo','tags',{'association':z(0xd1),'attributes':['id',y(0xcf)]}]},{'model':User_1[y(0xef)],'as':z(0x101),'attributes':['id',z(0xcf)]},{'association':y(0xec),'attributes':['id',y(0xcf),y(0xd5)]}]});if(k)return await k[z(0xca)]({'status':y(0xe8),'userId':null,'unreadMessages':e}),(0x0,socketEmit_1[z(0xef)])({'tenantId':f,'type':'ticket:update','payload':k}),k;}else{k=await Ticket_1[z(0xef)][y(0xf8)]({'where':{'status':{[sequelize_1['Op']['in']]:['open','pending']},'tenantId':f,'whatsappId':d,'contactId':c['id']},'order':[[z(0xfd),'DESC']],'include':[{'model':Contact_1['default'],'as':'contact','include':[y(0xf6),'tags',{'association':y(0xd1),'attributes':['id',y(0xcf)]}]},{'model':User_1[y(0xef)],'as':z(0x101),'attributes':['id',z(0xcf)]},{'association':'whatsapp','attributes':['id',y(0xcf),'isDeleted']}]});if(k)return await k[z(0xca)]({'status':'pending','userId':null,'unreadMessages':e}),(0x0,socketEmit_1[y(0xef)])({'tenantId':f,'type':'ticket:update','payload':k}),k;}const l=(await(0x0,ListSettingsService_1[y(0xef)])(f))?.[z(0xcd)](r=>r[y(0xff)]==='DirectTicketsToWallets')?.['value']===z(0xf9)||![],m={'contactId':g?g['id']:c['id'],'status':z(0xe8),'isGroup':!!g,'unreadMessages':e,'whatsappId':d,'tenantId':f,'channel':j};if(l&&c['id']){const r=c,s=await r[y(0xcc)]();s&&s[0x0]?.['id']&&(m[z(0xea)]=z(0xd6),m[y(0xda)]=s[0x0]['id'],m[y(0xf7)]=new Date()[y(0xcb)]());}h&&(m[y(0xfc)]=await(0x0,VerifyContactBaileys_1[y(0xe0)])(h));const n=await Ticket_1[z(0xef)][y(0xe1)](m);return await(0x0,CreateLogTicketService_1['default'])({'ticketId':n['id'],'type':y(0xe1)}),(h&&!h[y(0xff)][z(0xe7)]||!n[y(0xda)]||i)&&await(0x0,CheckChatBotFlowWelcome_1[y(0xef)])(n),k=await(0x0,ShowTicketService_1['default'])({'id':n['id'],'tenantId':f}),k['setDataValue'](z(0xe6),!![]),(0x0,socketEmit_1[y(0xef)])({'tenantId':f,'type':z(0x100),'payload':k}),k;};exports[v(0xef)]=FindOrCreateTicketService;