'use strict';function b(c,d){const e=a();return b=function(f,g){f=f-0xab;let h=e[f];return h;},b(c,d);}const w=b,y=b;(function(c,d){const u=b,v=b,e=c();while(!![]){try{const f=parseInt(u(0xca))/0x1*(parseInt(u(0xb7))/0x2)+-parseInt(v(0xbd))/0x3*(-parseInt(u(0xc8))/0x4)+-parseInt(u(0xcd))/0x5*(-parseInt(v(0xaf))/0x6)+-parseInt(v(0xc9))/0x7+parseInt(u(0xc1))/0x8+-parseInt(v(0xb0))/0x9*(parseInt(u(0xb1))/0xa)+-parseInt(u(0xd0))/0xb*(parseInt(v(0xac))/0xc);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x72e26));function a(){const B=['7368jwtTgS','isTransference','../../models/Contact','close','1235312nsbotP','name','startedAttendanceAt','../../models/Ticket','./CreateLogTicketService','receivedTransfer','ERR_NO_TICKET_FOUND','1024GGQOMz','3884797HjPNev','1XrcQFM','reload','__esModule','5kmxKus','closed','status','1064019klmHsa','findOne','wallets','../../errors/AppError','../../helpers/socketEmit','contact','default','getTime','defineProperty','extraInfo','36DkDhXB','pending','whatsapp','2288514wOLRLp','1017tFsXTp','4190fUaChm','closedAt','stepAutoReplyId','kDqfm','../../models/User','isDeleted','397004Mqatko','autoReplyId','rOWNj','open','fhxRk','__importDefault'];a=function(){return B;};return a();}var __importDefault=this&&this[w(0xbc)]||function(c){const x=w;return c&&c[x(0xcc)]?c:{'default':c};};Object[y(0xd8)](exports,y(0xcc),{'value':!![]});const AppError_1=__importDefault(require(y(0xd3))),CheckContactOpenTickets_1=__importDefault(require('../../helpers/CheckContactOpenTickets')),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),Contact_1=__importDefault(require(w(0xbf))),Ticket_1=__importDefault(require(w(0xc4))),User_1=__importDefault(require(y(0xb5))),socketEmit_1=__importDefault(require(y(0xd4))),CreateLogTicketService_1=__importDefault(require(w(0xc5))),UpdateTicketService=async({ticketData:c,ticketId:d,isTransference:e,userIdRequest:f})=>{const z=y,A=w,{status:g,userId:h,tenantId:i,queueId:j}=c,k=await Ticket_1['default'][z(0xd1)]({'where':{'id':d,'tenantId':i},'include':[{'model':Contact_1[z(0xd6)],'as':A(0xd5),'include':[A(0xab),'tags',{'association':z(0xd2),'attributes':['id',A(0xc2)]}]},{'model':User_1[A(0xd6)],'as':'user','attributes':['id',z(0xc2)]},{'association':z(0xae),'attributes':['id',z(0xc2),z(0xb6)]}]});if(!k)throw new AppError_1[(A(0xd6))](z(0xc7),0x194);await(0x0,SetTicketMessagesAsRead_1[A(0xd6)])(k);const l=k[z(0xcf)]!==z(0xad)&&c[z(0xcf)]===z(0xad),m=k[z(0xcf)],n=k['user']?.['id'];m==='closed'&&await(0x0,CheckContactOpenTickets_1[A(0xd6)])(k[A(0xd5)]['id']);const o=g===A(0xc0)?A(0xce):g,p={'status':o,'queueId':j,'userId':h};o===z(0xce)&&(p['closedAt']=new Date()[z(0xd7)]());m===z(0xad)&&o==='open'&&(p[A(0xb8)]=null,p[A(0xb3)]=null,p[A(0xc3)]=new Date()[A(0xd7)]());await k['update'](p);m===A(0xad)&&o===A(0xba)&&await(0x0,CreateLogTicketService_1['default'])({'userId':f,'ticketId':d,'type':A(0xba)});if(o===A(0xce)){if(A(0xb4)===z(0xb4))await(0x0,CreateLogTicketService_1[z(0xd6)])({'userId':f,'ticketId':d,'type':z(0xce)});else throw new d[(z(0xd6))](A(0xc7),0x194);}m===A(0xba)&&o==='pending'&&(z(0xbb)==='fhxRk'?await(0x0,CreateLogTicketService_1[z(0xd6)])({'userId':f,'ticketId':d,'type':z(0xad)}):(g['autoReplyId']=null,h[A(0xb3)]=null,i[z(0xc3)]=new j()['getTime']()));e&&(z(0xb9)===A(0xb9)?(await(0x0,CreateLogTicketService_1[A(0xd6)])({'userId':f,'ticketId':d,'type':'transfered'}),h&&await(0x0,CreateLogTicketService_1[z(0xd6)])({'userId':h,'ticketId':d,'type':A(0xc6)})):e[z(0xb2)]=new f()[z(0xd7)]());await k[z(0xcb)]();if(e){if('Vyzzu'!=='Vyzzu')return g&&h[z(0xcc)]?i:{'default':j};else await k['setDataValue'](z(0xbe),!![]);}return l&&(0x0,socketEmit_1[z(0xd6)])({'tenantId':i,'type':'notification:new','payload':k}),(0x0,socketEmit_1[A(0xd6)])({'tenantId':i,'type':'ticket:update','payload':k}),{'ticket':k,'oldStatus':m,'oldUserId':n};};exports[w(0xd6)]=UpdateTicketService;