'use strict';const u=b,w=b;(function(c,d){const s=b,t=b,e=c();while(!![]){try{const f=parseInt(s(0xb0))/0x1*(-parseInt(s(0xb8))/0x2)+parseInt(t(0xae))/0x3+parseInt(t(0xb2))/0x4+-parseInt(t(0xc2))/0x5+-parseInt(s(0xc5))/0x6+-parseInt(s(0xa2))/0x7+parseInt(s(0xad))/0x8*(parseInt(t(0xb9))/0x9);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x390af));var __importDefault=this&&this[u(0xb7)]||function(c){const v=u;return c&&c[v(0xbc)]?c:{'default':c};};Object[w(0xb4)](exports,w(0xbc),{'value':!![]});function a(){const z=['182673wCgcUl','status','621540qsMRzd','open','defineProperty','URcPE','getTime','__importDefault','2zeDfWn','9QirXaT','closedAt','receivedTransfer','__esModule','../../helpers/SetTicketMessagesAsRead','mqjBq','IFbrK','pending','notification:new','70695fgiOQj','findOne','isTransference','301380WcLnNt','./CreateLogTicketService','ERR_NO_TICKET_FOUND','tags','autoReplyId','name','closed','whatsapp','2454326MCaqbz','extraInfo','../../errors/AppError','../../helpers/CheckContactOpenTickets','DDSaU','ticket:update','default','stepAutoReplyId','../../models/Ticket','wallets','startedAttendanceAt','3036296DNnJwX','889155PeUKJQ','contact'];a=function(){return z;};return a();}const AppError_1=__importDefault(require(w(0xa4))),CheckContactOpenTickets_1=__importDefault(require(w(0xa5))),SetTicketMessagesAsRead_1=__importDefault(require(u(0xbd))),Contact_1=__importDefault(require('../../models/Contact')),Ticket_1=__importDefault(require(u(0xaa))),User_1=__importDefault(require('../../models/User')),socketEmit_1=__importDefault(require('../../helpers/socketEmit')),CreateLogTicketService_1=__importDefault(require(w(0xc6))),UpdateTicketService=async({ticketData:c,ticketId:d,isTransference:e,userIdRequest:f})=>{const x=w,y=w,{status:g,userId:h,tenantId:i,queueId:j}=c,k=await Ticket_1[x(0xa8)][x(0xc3)]({'where':{'id':d,'tenantId':i},'include':[{'model':Contact_1[x(0xa8)],'as':'contact','include':[y(0xa3),y(0x9d),{'association':y(0xab),'attributes':['id','name']}]},{'model':User_1[x(0xa8)],'as':'user','attributes':['id',y(0x9f)]},{'association':y(0xa1),'attributes':['id',y(0x9f),'isDeleted']}]});if(!k)throw new AppError_1[(x(0xa8))](y(0xc7),0x194);await(0x0,SetTicketMessagesAsRead_1[x(0xa8)])(k);const l=k[y(0xb1)]!==x(0xc0)&&c[x(0xb1)]==='pending',m=k['status'],n=k['user']?.['id'];m===y(0xa0)&&await(0x0,CheckContactOpenTickets_1[y(0xa8)])(k[x(0xaf)]['id']);const o=g==='close'?x(0xa0):g,p={'status':o,'queueId':j,'userId':h};o==='closed'&&(p[y(0xba)]=new Date()[x(0xb6)]());m===x(0xc0)&&o==='open'&&(p[y(0x9e)]=null,p[x(0xa9)]=null,p[x(0xac)]=new Date()['getTime']());await k['update'](p);m===x(0xc0)&&o===x(0xb3)&&await(0x0,CreateLogTicketService_1[y(0xa8)])({'userId':f,'ticketId':d,'type':y(0xb3)});o==='closed'&&(y(0xb5)!==x(0xbe)?await(0x0,CreateLogTicketService_1['default'])({'userId':f,'ticketId':d,'type':x(0xa0)}):e[y(0xba)]=new f()[x(0xb6)]());m===y(0xb3)&&o===y(0xc0)&&await(0x0,CreateLogTicketService_1['default'])({'userId':f,'ticketId':d,'type':y(0xc0)});e&&(await(0x0,CreateLogTicketService_1[y(0xa8)])({'userId':f,'ticketId':d,'type':'transfered'}),h&&await(0x0,CreateLogTicketService_1[y(0xa8)])({'userId':h,'ticketId':d,'type':y(0xbb)}));await k['reload']();e&&await k['setDataValue'](y(0xc4),!![]);if(l){if(y(0xa6)!==y(0xbf))(0x0,socketEmit_1[y(0xa8)])({'tenantId':i,'type':x(0xc1),'payload':k});else return g&&h[y(0xbc)]?i:{'default':j};}return(0x0,socketEmit_1['default'])({'tenantId':i,'type':y(0xa7),'payload':k}),{'ticket':k,'oldStatus':m,'oldUserId':n};};function b(c,d){const e=a();return b=function(f,g){f=f-0x9d;let h=e[f];return h;},b(c,d);}exports[w(0xa8)]=UpdateTicketService;