'use strict';const o=b,q=b;(function(c,d){const m=b,n=b,e=c();while(!![]){try{const f=-parseInt(m(0xb8))/0x1*(-parseInt(m(0xb9))/0x2)+-parseInt(m(0xd6))/0x3*(-parseInt(n(0xe2))/0x4)+parseInt(m(0xb1))/0x5+parseInt(n(0xdc))/0x6+-parseInt(n(0xcf))/0x7*(-parseInt(m(0xdb))/0x8)+parseInt(n(0xbb))/0x9*(-parseInt(n(0xbf))/0xa)+-parseInt(n(0xae))/0xb;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x6afee));var __importDefault=this&&this[o(0xbd)]||function(c){const p=o;return c&&c[p(0xba)]?c:{'default':c};};function a(){const v=['502460ISRAar','video','chat','update','body','360','individual','findAll','QqbXk','contact','number','BdRpT','mediaName','tokenAPI','tenantId','../../utils/logger','721HakJmq','info','../../helpers/SetTicketMessagesAsRead','dataValues','ASC','logger','image','3yRAeEv','timestamp','wabaMediaId','./SentMessage','ticket','33400MAdylC','4758300xnLaBa','sequelize','audio','lte','pending','voice','1950276lmRRDC','messages','document','../../models/Whatsapp','mediaType','Pkpvz','../../helpers/socketEmit','16175258jIVLFF','../../models/Message','chat:ack','2325715KVspHR','createdAt','Message\x20Update\x20ok','default','includes','sended','mediaUrl','11TUepgC','15394WCpILe','__esModule','63ptGpKr','text','__importDefault','waba'];a=function(){return v;};return a();}Object['defineProperty'](exports,q(0xba),{'value':!![]});function b(c,d){const e=a();return b=function(f,g){f=f-0xaa;let h=e[f];return h;},b(c,d);}const sequelize_1=require(q(0xdd)),SetTicketMessagesAsRead_1=__importDefault(require(o(0xd1))),socketEmit_1=__importDefault(require(q(0xad))),Message_1=__importDefault(require(o(0xaf))),Ticket_1=__importDefault(require('../../models/Ticket')),Whatsapp_1=__importDefault(require(o(0xaa))),logger_1=require(o(0xce)),SentMessage_1=__importDefault(require(q(0xd9))),buildWabaMessage360=async(c,d)=>{const r=o,s=o;let e={'timestamp':String(c[r(0xd7)]),'recipient_type':r(0xc5),'to':d,'type':s(0xbc)};return(c[r(0xab)]==='application'||c[r(0xab)]===r(0xe4))&&(e={...e,'type':r(0xe4),'document':{'id':c[r(0xd8)],'caption':c[s(0xc3)]||c[r(0xcb)]||''||''}}),c[r(0xab)]===r(0xd5)&&(e={...e,'type':'image','image':{'id':c[r(0xd8)],'caption':c[s(0xc3)]||c[s(0xcb)]||''}}),c[r(0xab)]===s(0xc0)&&(e={...e,'type':r(0xc0),'video':{'id':c[s(0xd8)],'caption':c[s(0xc3)]||c['mediaName']||''}}),(c['mediaType']==='audio'||c[r(0xab)]===s(0xe1))&&(s(0xac)!==s(0xca)?e={...e,'type':s(0xde),'audio':{'id':c['wabaMediaId'],'caption':c[r(0xc3)]||c['mediaName']||''}}:f={...g,'text':{'body':h[s(0xc3)]}}),(c['mediaType']===r(0xc1)||c[r(0xab)]===s(0xbc))&&(e={...e,'text':{'body':c[r(0xc3)]}}),e;},where={'fromMe':!![],'messageId':{[sequelize_1['Op']['is']]:null},'status':o(0xe0),[sequelize_1['Op']['or']]:[{'scheduleDate':{[sequelize_1['Op'][o(0xdf)]]:new Date()}},{'scheduleDate':{[sequelize_1['Op']['is']]:null}}]},Waba360SendMessagesSystem=async c=>{const t=q,u=q,d=await Message_1[t(0xb4)][u(0xc6)]({'where':where,'include':[t(0xc8),{'model':Ticket_1[u(0xb4)],'as':t(0xda),'where':{'tenantId':c[t(0xcd)],'channel':u(0xbe)},'include':[u(0xc8),{'model':Whatsapp_1[t(0xb4)],'as':'whatsapp','where':{'id':c['id'],'type':'waba','wabaBSP':u(0xc4)}}]},{'model':Message_1['default'],'as':'quotedMsg','include':[u(0xc8)]}],'order':[[t(0xb2),t(0xd3)]]});for(const e of d){if(u(0xc7)!=='QqbXk')h={...i,'type':'image','image':{'id':j[t(0xd8)],'caption':k[u(0xc3)]||l[t(0xcb)]||''}};else{const {ticket:g}=e,h=String(g['contact'][t(0xc9)]);if(![u(0xbc),t(0xc1)][t(0xb5)](e['mediaType'])&&e[t(0xb7)]&&!e[u(0xd8)]){}const i=await buildWabaMessage360(e,h),j=await(0x0,SentMessage_1[t(0xb4)])({'message':i,'apiKey':c[u(0xcc)]}),k={...e,'messageId':j[t(0xe3)][0x0]['id'],'status':t(0xb6),'ack':0x2};await Message_1[t(0xb4)][t(0xc2)]({...k},{'where':{'id':e['id']}}),(0x0,socketEmit_1[t(0xb4)])({'tenantId':g[t(0xcd)],'type':u(0xb0),'payload':{...k[t(0xd2)],'mediaUrl':e[t(0xb7)],'messageId':k['messageId'],'status':t(0xb6),'ack':0x2}}),logger_1[u(0xd4)][t(0xd0)](u(0xb3)),await(0x0,SetTicketMessagesAsRead_1[u(0xb4)])(g);}}};exports[o(0xb4)]=Waba360SendMessagesSystem;