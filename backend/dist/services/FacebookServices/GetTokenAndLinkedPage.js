'use strict';const o=b,q=b;function b(c,d){const e=a();return b=function(f,g){f=f-0xe7;let h=e[f];return h;},b(c,d);}(function(c,d){const m=b,n=b,e=c();while(!![]){try{const f=parseInt(m(0xfc))/0x1+parseInt(m(0x101))/0x2+-parseInt(n(0xf9))/0x3+parseInt(m(0xe7))/0x4*(parseInt(n(0x102))/0x5)+-parseInt(m(0xed))/0x6+-parseInt(n(0xf7))/0x7*(-parseInt(m(0x104))/0x8)+parseInt(m(0xf4))/0x9*(-parseInt(m(0x106))/0xa);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xddb71));var __importDefault=this&&this[o(0x108)]||function(c){const p=o;return c&&c[p(0x103)]?c:{'default':c};};function a(){const z=['3907812oAxceM','../../errors/AppError','env','axios','default','/oauth/access_token?grant_type=fb_exchange_token&client_id=','get','9iObTbv','/accounts?access_token=','access_token','35RKSKle','error','2660943jXRRNw','../../models/Whatsapp','../../utils/logger','5005RNCCmM','length','getIO','GET','&client_secret=','3093044OzUOzN','5bTFPky','__esModule','1099192SASmnD','FACEBOOK_APP_ID','8726030zQGynU','/accounts?limit=25&access_token=','__importDefault','v16.0','&fb_exchange_token=','update','4322036pXqVsM','emit','FACEBOOK_APP_SECRET_KEY','../../libs/socket',':whatsappSession','https://graph.facebook.com/'];a=function(){return z;};return a();}Object['defineProperty'](exports,o(0x103),{'value':!![]});const axios_1=__importDefault(require(q(0xf0))),AppError_1=__importDefault(require(q(0xee))),Whatsapp_1=__importDefault(require(o(0xfa))),SetLogoutLinkedPage_1=__importDefault(require('./SetLogoutLinkedPage')),socket_1=require(q(0xea)),logger_1=require(o(0xfb)),api_version=o(0x109),baseUrl=o(0xec)+api_version,app_id=process[o(0xef)][q(0x105)],app_secret=process[o(0xef)][o(0xe9)],getLongLivedAccessToken=async c=>{const r=o,s=q,{data:d}=await axios_1[r(0xf1)][s(0xf3)](baseUrl+r(0xf2)+app_id+s(0x100)+app_secret+s(0x10a)+c);return d['access_token'];},getPermanentPageAccessToken=async(c,d)=>{const t=o,u=q,{data:{data:e}}=await axios_1['default'][t(0xf3)](baseUrl+'/'+d+t(0xf5)+c);return e[u(0xfd)]&&e[0x0];},getPageInfo=async(c,d)=>{const v=q,w=q,e=baseUrl+'/'+c+v(0x107)+d,{data:{data:f}}=await(0x0,axios_1[w(0xf1)])({'method':w(0xff),'url':e});return f;},GetTokenAndLinkedPage=async({whatsapp:c,accountId:d,userToken:e,tenantId:f})=>{const x=q,y=o;try{const g=(0x0,socket_1[x(0xfe)])(),h=await getPageInfo(d,e);if(h[x(0xfd)]>0x1)throw new AppError_1[(y(0xf1))]('Escolha\x20apenas\x201\x20página.\x20Refaça\x20o\x20processo\x20e\x20selecione\x20apenas\x201\x20página.',0x190);if(h[y(0xfd)]===0x0){await(0x0,SetLogoutLinkedPage_1[y(0xf1)])({'whatsapp':c,'tenantId':f});return;}const i=await getLongLivedAccessToken(e),j=await getPermanentPageAccessToken(i,d),k={'status':'CONNECTED','fbPageId':j['id'],'fbObject':{...j,'accountId':d,'long_lived_access_token':i},'tokenAPI':j[y(0xf6)]};Whatsapp_1[y(0xf1)][y(0x10b)](k,{'where':{'id':c['id'],'tenantId':f}}),g[x(0xe8)](f+x(0xeb),{'action':x(0x10b),'session':{...c,...k}});}catch(l){logger_1['logger'][x(0xf8)](l);throw new AppError_1['default'](l,0x190);}};exports[q(0xf1)]=GetTokenAndLinkedPage;