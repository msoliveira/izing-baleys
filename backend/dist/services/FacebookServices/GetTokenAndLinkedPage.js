'use strict';const o=b,q=b;(function(c,d){const m=b,n=b,e=c();while(!![]){try{const f=parseInt(m(0x19a))/0x1*(-parseInt(n(0x19c))/0x2)+parseInt(m(0x195))/0x3*(-parseInt(m(0x18f))/0x4)+parseInt(m(0x193))/0x5*(parseInt(n(0x18a))/0x6)+-parseInt(n(0x192))/0x7+-parseInt(n(0x182))/0x8*(-parseInt(n(0x185))/0x9)+parseInt(m(0x1a3))/0xa*(parseInt(m(0x180))/0xb)+parseInt(n(0x188))/0xc;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x56b95));function a(){const z=['./SetLogoutLinkedPage','defineProperty','default','&client_secret=','68EmlYnt','/accounts?limit=25&access_token=','/accounts?access_token=','3607163BKDUIc','316815xXunqX','env','106563IZptAY','GET','../../utils/logger','CONNECTED','get','47JGaDPz','access_token','134Rlgogp','v16.0','__importDefault',':whatsappSession','__esModule','/oauth/access_token?grant_type=fb_exchange_token&client_id=','https://graph.facebook.com/','2590llnCbt','logger','update','getIO','length','24827OzLSBQ','FACEBOOK_APP_SECRET_KEY','8fojmuG','emit','../../models/Whatsapp','3025962SZlFtp','../../errors/AppError','error','5920704TfbeKs','&fb_exchange_token=','6xMwORt'];a=function(){return z;};return a();}var __importDefault=this&&this[o(0x19e)]||function(c){const p=o;return c&&c[p(0x1a0)]?c:{'default':c};};Object[q(0x18c)](exports,o(0x1a0),{'value':!![]});function b(c,d){const e=a();return b=function(f,g){f=f-0x17e;let h=e[f];return h;},b(c,d);}const axios_1=__importDefault(require('axios')),AppError_1=__importDefault(require(q(0x186))),Whatsapp_1=__importDefault(require(q(0x184))),SetLogoutLinkedPage_1=__importDefault(require(o(0x18b))),socket_1=require('../../libs/socket'),logger_1=require(o(0x197)),api_version=o(0x19d),baseUrl=o(0x1a2)+api_version,app_id=process[q(0x194)]['FACEBOOK_APP_ID'],app_secret=process['env'][q(0x181)],getLongLivedAccessToken=async c=>{const r=o,s=o,{data:d}=await axios_1[r(0x18d)][s(0x199)](baseUrl+r(0x1a1)+app_id+s(0x18e)+app_secret+r(0x189)+c);return d[r(0x19b)];},getPermanentPageAccessToken=async(c,d)=>{const t=o,u=q,{data:{data:e}}=await axios_1[t(0x18d)]['get'](baseUrl+'/'+d+t(0x191)+c);return e[t(0x17f)]&&e[0x0];},getPageInfo=async(c,d)=>{const v=q,w=o,e=baseUrl+'/'+c+v(0x190)+d,{data:{data:f}}=await(0x0,axios_1[v(0x18d)])({'method':v(0x196),'url':e});return f;},GetTokenAndLinkedPage=async({whatsapp:c,accountId:d,userToken:e,tenantId:f})=>{const x=q,y=q;try{const g=(0x0,socket_1[x(0x17e)])(),h=await getPageInfo(d,e);if(h[y(0x17f)]>0x1)throw new AppError_1[(x(0x18d))]('Escolha\x20apenas\x201\x20página.\x20Refaça\x20o\x20processo\x20e\x20selecione\x20apenas\x201\x20página.',0x190);if(h[y(0x17f)]===0x0){await(0x0,SetLogoutLinkedPage_1[x(0x18d)])({'whatsapp':c,'tenantId':f});return;}const i=await getLongLivedAccessToken(e),j=await getPermanentPageAccessToken(i,d),k={'status':y(0x198),'fbPageId':j['id'],'fbObject':{...j,'accountId':d,'long_lived_access_token':i},'tokenAPI':j[y(0x19b)]};Whatsapp_1[x(0x18d)][x(0x1a5)](k,{'where':{'id':c['id'],'tenantId':f}}),g[y(0x183)](f+y(0x19f),{'action':y(0x1a5),'session':{...c,...k}});}catch(l){logger_1[x(0x1a4)][x(0x187)](l);throw new AppError_1[(y(0x18d))](l,0x190);}};exports[o(0x18d)]=GetTokenAndLinkedPage;