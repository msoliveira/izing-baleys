'use strict';const L=b,M=b;function a(){const Z=['path','SOLfP','body','API','createWriteStream','850HOJAmS','originalname','create','QAEBf','authToken','apiConfig','ticket','__importDefault','findByPk','../../utils/pupa','OKzAV','indexOf','nUPSe','rmdirSync','../../helpers/socketEmit','1808714aFvAxt','error','headers','NfDII','message','mediaUrl','get','default','stream','CvHhJ','content-type','chat:create','type','getTime','5330400eThNxn','filename','653934OZrskl','839958CEasJE','../../utils/logger','QWxNv','substr','fromMe','../../models/Ticket','hookMessageStatus','data','chat','push','nPoNM','vECYJ','contactId','logger','whatsappId','WebHooksAPI','1409061iUFZUS','externalKey','ERROR\x20DONWLOAD','63jmycuc','urlMessageStatus','protocol','media','12lspgid','finish','1212235TFAUNf','public','98883pxUtIf','axios','../../libs/Queue','__esModule','all','../../models/Message','pupa','extension','quotedMsg','WYBpU','number','HauRa','mimetype','ERR_CREATING_MESSAGE_SYSTEM','../../utils/queueValidation','response','CreateMessageSystemService','split','contact','uuid','join','add','defineProperty','status'];a=function(){return Z;};return a();}(function(c,d){const J=b,K=b,e=c();while(!![]){try{const f=-parseInt(J(0x1c2))/0x1+-parseInt(K(0x209))/0x2+parseInt(K(0x1d2))/0x3+parseInt(K(0x1d9))/0x4*(parseInt(J(0x1db))/0x5)+-parseInt(J(0x1c1))/0x6*(-parseInt(J(0x1d5))/0x7)+-parseInt(K(0x1bf))/0x8+-parseInt(K(0x1dd))/0x9*(-parseInt(J(0x1fa))/0xa);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xab319));function b(c,d){const e=a();return b=function(f,g){f=f-0x1bd;let h=e[f];return h;},b(c,d);}var __importDefault=this&&this[L(0x201)]||function(c){return c&&c['__esModule']?c:{'default':c};};Object[L(0x1f3)](exports,M(0x1e0),{'value':!![]});const fs_1=__importDefault(require('fs')),path_1=require(M(0x1f5)),axios_1=__importDefault(require(M(0x1de))),mime_1=__importDefault(require('mime')),uuid_1=require(L(0x1f0)),logger_1=require(L(0x1c3)),Ticket_1=__importDefault(require(M(0x1c7))),Message_1=__importDefault(require(M(0x1e2))),socketEmit_1=__importDefault(require(L(0x208))),Queue_1=__importDefault(require(L(0x1df))),pupa_1=require(L(0x203)),queueValidation_1=__importDefault(require(L(0x1eb))),downloadMedia=async c=>{const N=L,O=L;try{const d=await axios_1[N(0x210)][N(0x20f)](c[O(0x20e)],{'responseType':O(0x211)}),e=d[N(0x20b)][N(0x213)],f=mime_1[N(0x210)],g=f[O(0x1e4)](e),h=(0x0,uuid_1['v4'])(),i=(0x0,path_1[O(0x1f1)])(__dirname,'..','..','..',O(0x1dc)),j=h+'.'+g,k=(0x0,path_1[N(0x1f1)])(i,j),l={'originalname':j,'filename':j,'mediaType':g};return await new Promise((m,n)=>{const P=O,Q=N;d[P(0x1c9)]['pipe'](fs_1[P(0x210)][P(0x1f9)](k))['on'](Q(0x1da),async()=>{const R=P,S=P;if(R(0x20c)===R(0x20c))m(l);else throw new d('ERR_CREATING_MESSAGE_SYSTEM');})['on'](Q(0x20a),o=>{const T=Q,U=Q;if(T(0x1f6)===T(0x1f6))console[U(0x20a)](T(0x1d4),o),fs_1[T(0x210)][T(0x207)](k,{'recursive':!![]}),n(new Error(o));else throw new d(U(0x1ea));});}),l;}catch(m){if(m['response'][O(0x1f4)]===0x194){const n={'ack':-0x1,'body':c[N(0x1f7)],'messageId':'','number':c[O(0x1e7)],'externalKey':c['externalKey'],'error':m[O(0x20d)],'authToken':c[N(0x1ff)][O(0x1fe)],'type':N(0x1c8)};return c?.['apiConfig']?.[N(0x1d6)]&&(N(0x1c4)===N(0x1c4)?Queue_1['default'][N(0x1f2)](O(0x1d1),{'url':c['apiConfig'][N(0x1d6)],'type':n[O(0x1bd)],'payload':n}):e(f)),{};}throw new Error(m);}},CreateMessageSystemService=async({msg:c,tenantId:d,medias:e,ticket:f,userId:g,scheduleDate:h,sendType:i,status:j,idFront:k})=>{const V=L,W=M,l={'ticketId':f['id'],'body':c['body'],'contactId':c?.[V(0x1c6)]?null:f[V(0x1ce)],'fromMe':i===V(0x1f8)?!![]:c?.[V(0x1c6)],'read':!![],'mediaType':W(0x1ca),'mediaUrl':undefined,'timestamp':new Date()[V(0x1be)](),'quotedMsgId':c?.[V(0x1e5)]?.['id'],'userId':g,'scheduleDate':h,'sendType':i,'status':j,'tenantId':d,'idFront':k};try{l[W(0x1f7)]=(0x0,pupa_1[V(0x1e3)])(c[V(0x1f7)]||'',{'protocol':f[V(0x1d7)],'name':f[W(0x1ef)]['name']});if(i==='API'&&c[V(0x20e)]){if(W(0x1cc)===V(0x204))e[W(0x1cf)][W(0x20a)](f);else{e=[];const n=await downloadMedia(c);e[V(0x1cb)](n);}}if(i===V(0x1f8)&&!c[W(0x20e)]&&c['media']){if(V(0x206)==='LcadU'){if(!g['filename']){const p=k[V(0x1e9)][W(0x1ee)]('/')[0x1][W(0x1ee)](';')[0x0];l[V(0x1c0)]=new m()[V(0x1be)]()+'.'+p;}}else e=[],e[V(0x1cb)](c[V(0x1d8)]);}if(e)await Promise[V(0x1e1)](e['map'](async p=>{const X=V,Y=W;if(X(0x1e8)!=='HauRa')return g&&h[X(0x1e0)]?i:{'default':j};else{try{if(!p[Y(0x1c0)]){if(Y(0x1e6)==='sSVjL'){const v=f[X(0x1e9)][Y(0x1ee)]('/')[0x1]['split'](';')[0x0];g[Y(0x1c0)]=new h()['getTime']()+'.'+v;}else{const v=p['mimetype'][Y(0x1ee)]('/')[0x1]['split'](';')[0x0];p[Y(0x1c0)]=new Date()['getTime']()+'.'+v;}}}catch(w){Y(0x1cd)==='vECYJ'?logger_1[Y(0x1cf)][Y(0x20a)](w):g['default'][X(0x1f2)](X(0x1d1),{'url':h[Y(0x1ff)][Y(0x1d6)],'type':i['type'],'payload':j});}const r={...l,'body':p[X(0x1fb)],'mediaUrl':p[X(0x1c0)],'mediaType':p['mediaType']||p[X(0x1e9)][X(0x1c5)](0x0,p[Y(0x1e9)][X(0x205)]('/'))},s=await Message_1[X(0x210)][X(0x1fc)](r),t=await Message_1[X(0x210)][Y(0x202)](s['id'],{'include':[{'model':Ticket_1[Y(0x210)],'as':Y(0x200),'where':{'tenantId':d},'include':[Y(0x1ef)]},{'model':Message_1['default'],'as':X(0x1e5),'include':[X(0x1ef)]}]});if(!t){if(X(0x212)===Y(0x212))throw new Error('ERR_CREATING_MESSAGE_SYSTEM');else e[X(0x1cf)]['error'](X(0x1ed),f);}return await f['update']({'lastMessage':t['body'],'lastMessageAt':new Date()[X(0x1be)]()}),(0x0,socketEmit_1[Y(0x210)])({'tenantId':d,'type':Y(0x214),'payload':t}),!t['scheduleDate']&&await(0x0,queueValidation_1['default'])(f[Y(0x1d0)],d,[t]),t;}}));else{const p=await Message_1[V(0x210)][W(0x1fc)]({...l,'mediaType':V(0x1ca)}),q=await Message_1[V(0x210)][W(0x202)](p['id'],{'include':[{'model':Ticket_1[W(0x210)],'as':W(0x200),'where':{'tenantId':d},'include':['contact']},{'model':Message_1[V(0x210)],'as':'quotedMsg','include':[W(0x1ef)]}]});if(!q)throw new Error(W(0x1ea));return await f['update']({'lastMessage':q[V(0x1f7)],'lastMessageAt':new Date()[V(0x1be)](),'answered':!![]}),q['ticket']=f,(0x0,socketEmit_1[W(0x210)])({'tenantId':d,'type':'chat:create','payload':q}),!q['scheduleDate']&&await(0x0,queueValidation_1[V(0x210)])(f[W(0x1d0)],d,[q]),q;}}catch(r){if(V(0x1fd)!==V(0x1fd)){if(n[V(0x1ec)][V(0x1f4)]===0x194){const t={'ack':-0x1,'body':y[V(0x1f7)],'messageId':'','number':z[V(0x1e7)],'externalKey':A[V(0x1d3)],'error':B[V(0x20d)],'authToken':C[V(0x1ff)][W(0x1fe)],'type':W(0x1c8)};return D?.[V(0x1ff)]?.['urlMessageStatus']&&G[W(0x210)][V(0x1f2)](W(0x1d1),{'url':H[W(0x1ff)][W(0x1d6)],'type':t[W(0x1bd)],'payload':t}),{};}throw new w(x);}else logger_1[W(0x1cf)]['error'](V(0x1ed),r);}};exports[L(0x210)]=CreateMessageSystemService;