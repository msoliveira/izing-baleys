'use strict';function a(){const a1=['message','scheduleDate','stream','split','1040380cGNbDI','error','content-type','uuid','fromMe','name','CreateMessageSystemService','number','345764aiDBaZ','substr','getTime','wAgXQ','axios','uKdko','authToken','logger','default','WebHooksAPI','QgCyJ','../../utils/logger','data','filename','6VNxzoa','ERR_CREATING_MESSAGE_SYSTEM','add','externalKey','8824239ZqBZDu','__importDefault','mime','AEILI','response','../../libs/Queue','mediaUrl','1228800yDSrlJ','join','media','create','mediaType','../../models/Message','status','../../utils/queueValidation','chat','85825ebSLHr','finish','protocol','public','type','update','findByPk','defineProperty','DCNZk','ERROR\x20DONWLOAD','8ttzNgu','oysEI','../../utils/pupa','contactId','body','SzDqT','API','push','zXxDv','urlMessageStatus','createWriteStream','quotedMsg','apiConfig','vVdED','mimetype','headers','pipe','indexOf','401422hslYyP','vLVZz','QfGTg','Dvpcp','map','hookMessageStatus','bVugj','188480PKYTwD','nTrCF','ivtgB','ticket','__esModule','contact','xkRSp','get'];a=function(){return a1;};return a();}const L=b,M=b;function b(c,d){const e=a();return b=function(f,g){f=f-0x1d7;let h=e[f];return h;},b(c,d);}(function(c,d){const J=b,K=b,e=c();while(!![]){try{const f=parseInt(J(0x1f7))/0x1+parseInt(J(0x21a))/0x2+-parseInt(J(0x1ee))/0x3+-parseInt(K(0x22e))/0x4+-parseInt(J(0x226))/0x5+-parseInt(K(0x1e3))/0x6*(parseInt(J(0x213))/0x7)+-parseInt(J(0x201))/0x8*(-parseInt(J(0x1e7))/0x9);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x616e1));var __importDefault=this&&this[L(0x1e8)]||function(c){return c&&c['__esModule']?c:{'default':c};};Object[M(0x1fe)](exports,M(0x21e),{'value':!![]});const fs_1=__importDefault(require('fs')),path_1=require('path'),axios_1=__importDefault(require(M(0x1d9))),mime_1=__importDefault(require(M(0x1e9))),uuid_1=require(M(0x229)),logger_1=require(M(0x1e0)),Ticket_1=__importDefault(require('../../models/Ticket')),Message_1=__importDefault(require(L(0x1f3))),socketEmit_1=__importDefault(require('../../helpers/socketEmit')),Queue_1=__importDefault(require(M(0x1ec))),pupa_1=require(M(0x203)),queueValidation_1=__importDefault(require(M(0x1f5))),downloadMedia=async c=>{const N=M,O=L;try{if(N(0x1ea)===O(0x1d8))j[N(0x227)](N(0x200),k),l[N(0x1dd)]['rmdirSync'](m,{'recursive':!![]}),n(new o(p));else{const e=await axios_1['default'][N(0x221)](c[N(0x1ed)],{'responseType':O(0x224)}),f=e[N(0x210)][N(0x228)],g=mime_1['default'],h=g['extension'](f),i=(0x0,uuid_1['v4'])(),j=(0x0,path_1[N(0x1ef)])(__dirname,'..','..','..',N(0x1fa)),k=i+'.'+h,l=(0x0,path_1[O(0x1ef)])(j,k),m={'originalname':k,'filename':k,'mediaType':h};return await new Promise((n,o)=>{const P=N,Q=N;if(P(0x220)!=='xkRSp'){const q={'ack':-0x1,'body':k[Q(0x205)],'messageId':'','number':l[Q(0x22d)],'externalKey':m[Q(0x1e6)],'error':n[P(0x222)],'authToken':o[Q(0x20d)][P(0x1db)],'type':P(0x218)};return p?.['apiConfig']?.[Q(0x20a)]&&s[Q(0x1dd)][P(0x1e5)](Q(0x1de),{'url':t[Q(0x20d)][P(0x20a)],'type':q[Q(0x1fb)],'payload':q}),{};}else e[P(0x1e1)][Q(0x211)](fs_1[P(0x1dd)]['createWriteStream'](l))['on'](P(0x1f8),async()=>{const R=Q,S=Q;if(R(0x214)!=='fzCAS')n(m);else throw new d(R(0x1e4));})['on'](Q(0x227),q=>{const T=Q,U=P;T(0x209)!=='YQYdD'?(console[U(0x227)]('ERROR\x20DONWLOAD',q),fs_1[U(0x1dd)]['rmdirSync'](l,{'recursive':!![]}),o(new Error(q))):e(f);});}),m;}}catch(n){if(N(0x216)!==N(0x1ff)){if(n[N(0x1eb)][N(0x1f4)]===0x194){if(O(0x1da)==='RtObR')e[O(0x1dc)][N(0x227)](f);else{const p={'ack':-0x1,'body':c['body'],'messageId':'','number':c[N(0x22d)],'externalKey':c[O(0x1e6)],'error':n[O(0x222)],'authToken':c[N(0x20d)][O(0x1db)],'type':N(0x218)};return c?.[N(0x20d)]?.[N(0x20a)]&&Queue_1[O(0x1dd)][O(0x1e5)](O(0x1de),{'url':c[N(0x20d)]['urlMessageStatus'],'type':p[N(0x1fb)],'payload':p}),{};}}throw new Error(n);}else e[N(0x1dc)]['error'](N(0x22c),f);}},CreateMessageSystemService=async({msg:c,tenantId:d,medias:e,ticket:f,userId:g,scheduleDate:h,sendType:i,status:j,idFront:k})=>{const V=M,W=M,l={'ticketId':f['id'],'body':c['body'],'contactId':c?.[V(0x22a)]?null:f[W(0x204)],'fromMe':i==='API'?!![]:c?.['fromMe'],'read':!![],'mediaType':V(0x1f6),'mediaUrl':undefined,'timestamp':new Date()[W(0x1d7)](),'quotedMsgId':c?.['quotedMsg']?.['id'],'userId':g,'scheduleDate':h,'sendType':i,'status':j,'tenantId':d,'idFront':k};try{l[V(0x205)]=(0x0,pupa_1['pupa'])(c['body']||'',{'protocol':f[V(0x1f9)],'name':f[V(0x21f)][V(0x22b)]});if(i===V(0x207)&&c['mediaUrl']){e=[];const m=await downloadMedia(c);e[W(0x208)](m);}if(i==='API'&&!c[W(0x1ed)]&&c[W(0x1f0)]){if('vVdED'===W(0x20e))e=[],e[W(0x208)](c[W(0x1f0)]);else{if(n[V(0x1eb)][V(0x1f4)]===0x194){const o={'ack':-0x1,'body':y['body'],'messageId':'','number':z['number'],'externalKey':A['externalKey'],'error':B[V(0x222)],'authToken':C[V(0x20d)]['authToken'],'type':W(0x218)};return D?.['apiConfig']?.['urlMessageStatus']&&G['default'][V(0x1e5)](W(0x1de),{'url':H[W(0x20d)][W(0x20a)],'type':o['type'],'payload':o}),{};}throw new w(x);}}if(e){if(W(0x1df)===V(0x21c)){const p=f[V(0x20f)][V(0x225)]('/')[0x1][W(0x225)](';')[0x0];g[W(0x1e2)]=new h()[V(0x1d7)]()+'.'+p;}else await Promise['all'](e[W(0x217)](async p=>{const X=V,Y=V;try{if(!p[X(0x1e2)]){if('WPOTh'!=='WPOTh')g[Y(0x1dd)][X(0x1e5)](X(0x1de),{'url':h['apiConfig'][X(0x20a)],'type':i[X(0x1fb)],'payload':j});else{const u=p[X(0x20f)][Y(0x225)]('/')[0x1]['split'](';')[0x0];p[X(0x1e2)]=new Date()[X(0x1d7)]()+'.'+u;}}}catch(v){X(0x215)!=='QfGTg'?(f=[],g[Y(0x208)](h[Y(0x1f0)])):logger_1['logger']['error'](v);}const q={...l,'body':p['originalname'],'mediaUrl':p[Y(0x1e2)],'mediaType':p[Y(0x1f2)]||p[Y(0x20f)][Y(0x22f)](0x0,p[X(0x20f)][X(0x212)]('/'))},r=await Message_1[Y(0x1dd)][Y(0x1f1)](q),s=await Message_1[X(0x1dd)][Y(0x1fd)](r['id'],{'include':[{'model':Ticket_1[X(0x1dd)],'as':X(0x21d),'where':{'tenantId':d},'include':[X(0x21f)]},{'model':Message_1[X(0x1dd)],'as':X(0x20c),'include':['contact']}]});if(!s){if(X(0x21b)===Y(0x206))m[Y(0x1e1)][X(0x211)](n[Y(0x1dd)][Y(0x20b)](o))['on'](Y(0x1f8),async()=>{w(x);})['on'](X(0x227),C=>{const Z=Y,a0=Y;w[Z(0x227)]('ERROR\x20DONWLOAD',C),x[Z(0x1dd)]['rmdirSync'](y,{'recursive':!![]}),z(new A(C));});else throw new Error(Y(0x1e4));}return await f[Y(0x1fc)]({'lastMessage':s[Y(0x205)],'lastMessageAt':new Date()[X(0x1d7)]()}),(0x0,socketEmit_1[Y(0x1dd)])({'tenantId':d,'type':'chat:create','payload':s}),!s[X(0x223)]&&await(0x0,queueValidation_1[X(0x1dd)])(f['whatsappId'],d,[s]),s;}));}else{const p=await Message_1['default'][V(0x1f1)]({...l,'mediaType':W(0x1f6)}),q=await Message_1[V(0x1dd)][V(0x1fd)](p['id'],{'include':[{'model':Ticket_1[V(0x1dd)],'as':'ticket','where':{'tenantId':d},'include':['contact']},{'model':Message_1[W(0x1dd)],'as':V(0x20c),'include':['contact']}]});if(!q){if(V(0x202)!==V(0x219))throw new Error(W(0x1e4));else throw new d(W(0x1e4));}return await f[V(0x1fc)]({'lastMessage':q[V(0x205)],'lastMessageAt':new Date()[W(0x1d7)](),'answered':!![]}),q[W(0x21d)]=f,(0x0,socketEmit_1[W(0x1dd)])({'tenantId':d,'type':'chat:create','payload':q}),!q[W(0x223)]&&await(0x0,queueValidation_1['default'])(f['whatsappId'],d,[q]),q;}}catch(s){logger_1[V(0x1dc)]['error'](V(0x22c),s);}};exports['default']=CreateMessageSystemService;