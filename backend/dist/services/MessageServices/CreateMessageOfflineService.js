'use strict';const v=b,x=b;(function(c,d){const t=b,u=b,e=c();while(!![]){try{const f=-parseInt(t(0x19d))/0x1+parseInt(u(0x16b))/0x2+parseInt(u(0x1a1))/0x3*(parseInt(u(0x193))/0x4)+parseInt(u(0x178))/0x5*(-parseInt(u(0x198))/0x6)+-parseInt(t(0x195))/0x7*(-parseInt(t(0x16f))/0x8)+-parseInt(u(0x18a))/0x9+parseInt(t(0x19c))/0xa;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xdafb6));function b(c,d){const e=a();return b=function(f,g){f=f-0x16b;let h=e[f];return h;},b(c,d);}var __importDefault=this&&this[v(0x177)]||function(c){const w=v;return c&&c[w(0x1a3)]?c:{'default':c};};Object[v(0x171)](exports,'__esModule',{'value':!![]});const fs_1=require('fs'),util_1=require(x(0x184)),path_1=require(v(0x17f)),logger_1=require(x(0x189)),MessageOffLine_1=__importDefault(require(x(0x199))),socket_1=require(v(0x1a4)),Ticket_1=__importDefault(require('../../models/Ticket')),Message_1=__importDefault(require(v(0x19e))),writeFileAsync=(0x0,util_1[x(0x19a)])(fs_1[v(0x16e)]),CreateMessageOffilineService=async({msg:c,tenantId:d,medias:e,ticket:f,userId:g})=>{const y=v,z=v,h=(0x0,socket_1[y(0x176)])(),i={'wId':undefined,'ticketId':f['id'],'body':c[y(0x18b)],'contactId':f[z(0x173)],'fromMe':c['fromMe'],'read':!![],'mediaType':z(0x187),'mediaUrl':undefined,'timestamp':undefined,'userId':g};try{if(y(0x194)===z(0x194)){if(e){if(z(0x17e)!==z(0x17e))return g&&h[y(0x1a3)]?i:{'default':j};else await Promise['all'](e[z(0x17a)](async k=>{const A=z,B=z;if('jmoyc'===A(0x18e)){try{if(!k[A(0x191)]){if(A(0x19f)===B(0x17c))throw new d('ERR_CREATING_MESSAGE');else{const p=k[B(0x192)][B(0x188)]('/')[0x1][B(0x188)](';')[0x0];k[B(0x191)]=new Date()[A(0x18c)]()+'.'+p;}}await writeFileAsync((0x0,path_1['join'])(__dirname,'..','..','..','..','public',k['filename']),k[A(0x180)],A(0x185));}catch(q){if('smgvs'!==A(0x197)){const s=f[A(0x192)]['split']('/')[0x1][A(0x188)](';')[0x0];g[A(0x191)]=new h()[A(0x18c)]()+'.'+s;}else logger_1['logger'][A(0x16d)](q);}const l={...i,'mediaUrl':k[B(0x191)],'mediaType':k[A(0x192)][A(0x175)](0x0,k[A(0x192)][A(0x170)]('/'))},m=await MessageOffLine_1[B(0x190)][A(0x186)](l),n=await MessageOffLine_1[B(0x190)][A(0x19b)](m['id'],{'include':[B(0x18f),{'model':Ticket_1[A(0x190)],'as':B(0x196),'where':{'tenantId':d},'include':[B(0x18f)]},{'model':Message_1['default'],'as':A(0x174),'include':[A(0x18f)]}]});if(!n)throw new Error('ERR_CREATING_MESSAGE');h['to'](d+'-'+n['ticketId'][B(0x1a2)]())['to'](d+'-'+n[A(0x196)]['status'])['to'](d+'-notification')['emit'](d+'-appMessage',{'action':B(0x186),'message':n,'ticket':n[B(0x196)],'contact':n['ticket'][B(0x18f)]}),await f['update']({'lastMessage':n[A(0x18b)],'lastMessageAt':new Date()[A(0x18c)]()});}else throw new d('ERR_CREATING_MESSAGE');}));}else{const k=await MessageOffLine_1[y(0x190)][y(0x186)]({...i,'mediaType':z(0x187)}),l=await MessageOffLine_1[z(0x190)][y(0x19b)](k['id'],{'include':['contact',{'model':Ticket_1[y(0x190)],'as':'ticket','where':{'tenantId':d},'include':[y(0x18f)]},{'model':Message_1['default'],'as':'quotedMsg','include':[y(0x18f)]}]});if(!l){if('bCTAr'!==z(0x1a0))throw new Error(y(0x16c));else e[y(0x172)][y(0x16d)](f);}await f[y(0x18d)]({'lastMessage':l[z(0x18b)],'lastMessageAt':new Date()['getTime']()}),h['to'](d+'-'+l[z(0x183)]['toString']())['to'](d+'-'+l[y(0x196)][z(0x179)])['to'](d+y(0x182))[z(0x181)](d+z(0x17d),{'action':'create','message':l,'ticket':l[z(0x196)],'contact':l[z(0x196)]['contact']});}}else e[z(0x172)][z(0x16d)](z(0x17b),f);}catch(o){logger_1['logger'][y(0x16d)](z(0x17b),o);}};exports[x(0x190)]=CreateMessageOffilineService;function a(){const C=['../../utils/logger','12999564diaRLa','body','getTime','update','jmoyc','contact','default','filename','mimetype','4711996uAWMen','wfzpg','698173BcYLnI','ticket','smgvs','709638anRHBD','../../models/MessageOffLine','promisify','findByPk','21213500uibQOB','479649PWljuX','../../models/Message','chfQG','Uiujb','3SSsXtj','toString','__esModule','../../libs/socket','323088tCYILB','ERR_CREATING_MESSAGE','error','writeFile','72EAvRpk','indexOf','defineProperty','logger','contactId','quotedMsg','substr','getIO','__importDefault','65RPnAKp','status','map','CreateMessageOffLineService','ESNyt','-appMessage','JkXSb','path','buffer','emit','-notification','ticketId','util','base64','create','chat','split'];a=function(){return C;};return a();}