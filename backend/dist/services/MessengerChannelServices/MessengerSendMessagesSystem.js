'use strict';const y=b,A=b;(function(c,d){const w=b,x=b,e=c();while(!![]){try{const f=parseInt(w(0x150))/0x1+-parseInt(x(0x13f))/0x2*(-parseInt(w(0x162))/0x3)+-parseInt(w(0x127))/0x4*(-parseInt(w(0x15d))/0x5)+parseInt(w(0x134))/0x6*(-parseInt(w(0x139))/0x7)+-parseInt(w(0x14b))/0x8*(parseInt(x(0x15a))/0x9)+-parseInt(w(0x152))/0xa+parseInt(w(0x13d))/0xb;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xe088b));function a(){const F=['public','closed','messenger','messageId','video','951612VvlKMA','fluent-ffmpeg','sendText','ticket','chat:ack','49bFZQBn','file','../../utils/logger','saveToFile','19093195XISrxK','__importDefault','8MacAqv','contact','audio','join','dataValues','chat','logger','readFile','toBuffer','sharp','text','sendAudio','56728OpUDnQ','error','toFormat','Message\x20Update\x20ok','mediaName','639487EVzKyY','timestamp','10303430oJjyzY','path','info','sended','ptt','quotedMsg','findAll','Error\x20message\x20is\x20(tenant:\x20','1323cAdKXg','jpeg','.mp4','5neacTS','tenantId','default','ASC','createdAt','891444ETBrju','sleepRandomTime','sendVideo','defineProperty','sendFile','\x20|\x20Ticket:\x20','mediaUrl','includes','update','2155204vADUXt','mediaType','__esModule','mp4','pending',')::\x20','messengerId','application'];a=function(){return F;};return a();}var __importDefault=this&&this[y(0x13e)]||function(c){const z=y;return c&&c[z(0x129)]?c:{'default':c};};Object[y(0x165)](exports,A(0x129),{'value':!![]});function b(c,d){const e=a();return b=function(f,g){f=f-0x126;let h=e[f];return h;},b(c,d);}const promises_1=require('fs/promises'),fluent_ffmpeg_1=__importDefault(require(A(0x135))),path_1=require(y(0x153)),sequelize_1=require('sequelize'),sharp_1=__importDefault(require(y(0x148))),socketEmit_1=__importDefault(require('../../helpers/socketEmit')),Message_1=__importDefault(require('../../models/Message')),Ticket_1=__importDefault(require('../../models/Ticket')),logger_1=require(y(0x13b)),sleepRandomTime_1=require('../../utils/sleepRandomTime'),MessengerSendMessagesSystem=async(c,d)=>{const B=A,C=A,e={'fromMe':!![],'messageId':{[sequelize_1['Op']['is']]:null},'status':B(0x12b),[sequelize_1['Op']['or']]:[{'scheduleDate':{[sequelize_1['Op']['lte']]:new Date()}},{'scheduleDate':{[sequelize_1['Op']['is']]:null}}]},f=await Message_1[C(0x15f)][C(0x158)]({'where':e,'include':[B(0x140),{'model':Ticket_1[B(0x15f)],'as':B(0x137),'where':{'tenantId':d,[sequelize_1['Op']['or']]:{'status':{[sequelize_1['Op']['ne']]:B(0x130)},'isFarewellMessage':!![]},'channel':C(0x131),'whatsappId':c['id']},'include':[B(0x140)]},{'model':Message_1['default'],'as':B(0x157),'include':[C(0x140)]}],'order':[[C(0x161),C(0x160)]]});let g;for(const h of f){const i=h,{ticket:j}=i,k=j[B(0x140)][C(0x12d)];try{if(![C(0x144),B(0x149)][C(0x169)](i[C(0x128)])&&i[C(0x14f)]){const m=(0x0,path_1['join'])(__dirname,'..','..','..',C(0x12f)),n=(0x0,path_1[C(0x142)])(m,i[C(0x14f)]),o=await(0x0,promises_1[B(0x146)])(n);console['log'](n);if(i[C(0x128)]===B(0x141)||i[C(0x128)]===C(0x156)){const p=i['mediaName']['split']('.'),q=(0x0,path_1['join'])(m,p[0x0]+B(0x15c));await new Promise((s,t)=>{const D=C,E=C;(0x0,fluent_ffmpeg_1[D(0x15f)])(n)[E(0x14d)](E(0x12a))['on'](E(0x14c),u=>t(u))['on']('end',()=>s(!![]))[E(0x13c)](q);});const r=await(0x0,promises_1[C(0x146)])(q);g=await c[C(0x14a)](k,r);}if(i[B(0x128)]==='image'){const s=await(0x0,sharp_1['default'])(o)[B(0x15b)]()[C(0x147)]();g=await c['sendImage'](k,s,{'filename':i[C(0x14f)]});}i[B(0x128)]===B(0x133)&&(g=await c[B(0x164)](k,o,{'filename':i['mediaName']})),[B(0x12e),C(0x13a),'document'][B(0x169)](i[C(0x128)])&&(g=await c[C(0x166)](k,o,{'filename':i[C(0x14f)]}));}[C(0x144),'text'][B(0x169)](i['mediaType'])&&!i['mediaName']&&(g=await c[C(0x136)](k,i['body']));const l={...i,...g,'id':i['id'],'timestamp':i[B(0x151)],'messageId':g[B(0x132)],'status':C(0x155),'ack':0x2};await Message_1[C(0x15f)][C(0x126)]({...l},{'where':{'id':i['id']}}),(0x0,socketEmit_1['default'])({'tenantId':j[B(0x15e)],'type':B(0x138),'payload':{...i[C(0x143)],'mediaUrl':i[C(0x168)],'id':i['id'],'timestamp':i[B(0x151)],'messageId':g['messageId'],'status':B(0x155),'ack':0x2}}),logger_1[B(0x145)][B(0x154)](B(0x14e)),await(0x0,sleepRandomTime_1[C(0x163)])({'minMilliseconds':Number(0x1f4),'maxMilliseconds':Number(0x5dc)});}catch(t){const u=i['id'],v=i[B(0x137)]['id'];logger_1[B(0x145)][C(0x14c)](C(0x159)+d+C(0x167)+v+')'),logger_1['logger'][C(0x14c)]('Error\x20send\x20message\x20(id:\x20'+u+B(0x12c)+t);}}};exports['default']=MessengerSendMessagesSystem;