'use strict';const z=b,A=b;(function(c,d){const w=b,x=b,e=c();while(!![]){try{const f=parseInt(w(0xa8))/0x1*(-parseInt(w(0xe2))/0x2)+parseInt(x(0xb0))/0x3+parseInt(x(0xc2))/0x4*(-parseInt(x(0xc9))/0x5)+-parseInt(w(0xcc))/0x6*(-parseInt(x(0xb4))/0x7)+parseInt(w(0xce))/0x8+-parseInt(w(0xdb))/0x9+-parseInt(x(0xc8))/0xa*(parseInt(w(0xdf))/0xb);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x942ee));var __importDefault=this&&this['__importDefault']||function(c){const y=b;return c&&c[y(0xa4)]?c:{'default':c};};function b(c,d){const e=a();return b=function(f,g){f=f-0xa1;let h=e[f];return h;},b(c,d);}Object[z(0xde)](exports,z(0xa4),{'value':!![]});function a(){const F=['error','sendAudio','8fhuifu','sharp','end','tenantId','timestamp','chat:ack','includes','../../models/Message','2432151IroCzq','sequelize','file','sendVideo','7CXGiZb','chat','logger','../../helpers/socketEmit','Error\x20message\x20is\x20(tenant:\x20','lte','sended','findAll','../../models/Ticket','.mp4','video','../../utils/sleepRandomTime','messageId','ptt','4ealvLd','fs/promises','fluent-ffmpeg','default','createdAt','ASC','10uMiSNG','1790005vlJBgw','Message\x20Update\x20ok','sendImage','6679242TrPAvN','public','7491000kAhWGC','\x20|\x20Ticket:\x20','text','contact','ticket','join','messengerId','sleepRandomTime','toBuffer','application','pending','dataValues','../../utils/logger','8798958IPhZHw','readFile','document','defineProperty','9200730ZWVWqo','mediaName','messenger','20312UNFDee','image',')::\x20','mp4','mediaType','__esModule','closed'];a=function(){return F;};return a();}const promises_1=require(z(0xc3)),fluent_ffmpeg_1=__importDefault(require(z(0xc4))),path_1=require('path'),sequelize_1=require(z(0xb1)),sharp_1=__importDefault(require(z(0xa9))),socketEmit_1=__importDefault(require(z(0xb7))),Message_1=__importDefault(require(z(0xaf))),Ticket_1=__importDefault(require(z(0xbc))),logger_1=require(A(0xda)),sleepRandomTime_1=require(A(0xbf)),MessengerSendMessagesSystem=async(c,d)=>{const B=A,C=A,e={'fromMe':!![],'messageId':{[sequelize_1['Op']['is']]:null},'status':B(0xd8),[sequelize_1['Op']['or']]:[{'scheduleDate':{[sequelize_1['Op'][B(0xb9)]]:new Date()}},{'scheduleDate':{[sequelize_1['Op']['is']]:null}}]},f=await Message_1[B(0xc5)][B(0xbb)]({'where':e,'include':[B(0xd1),{'model':Ticket_1['default'],'as':C(0xd2),'where':{'tenantId':d,[sequelize_1['Op']['or']]:{'status':{[sequelize_1['Op']['ne']]:C(0xa5)},'isFarewellMessage':!![]},'channel':B(0xe1),'whatsappId':c['id']},'include':['contact']},{'model':Message_1[B(0xc5)],'as':'quotedMsg','include':[B(0xd1)]}],'order':[[C(0xc6),C(0xc7)]]});let g;for(const h of f){const i=h,{ticket:j}=i,k=j['contact'][B(0xd4)];try{if(!['chat',C(0xd0)][B(0xae)](i[C(0xa3)])&&i[B(0xe0)]){const m=(0x0,path_1[C(0xd3)])(__dirname,'..','..','..',B(0xcd)),n=(0x0,path_1[C(0xd3)])(m,i[B(0xe0)]),o=await(0x0,promises_1[B(0xdc)])(n);console['log'](n);if(i[B(0xa3)]==='audio'||i[B(0xa3)]===B(0xc1)){const p=i[C(0xe0)]['split']('.'),q=(0x0,path_1[C(0xd3)])(m,p[0x0]+C(0xbd));await new Promise((s,t)=>{const D=B,E=C;(0x0,fluent_ffmpeg_1['default'])(n)['toFormat'](D(0xa2))['on'](E(0xa6),u=>t(u))['on'](E(0xaa),()=>s(!![]))['saveToFile'](q);});const r=await(0x0,promises_1[C(0xdc)])(q);g=await c[C(0xa7)](k,r);}if(i[B(0xa3)]===B(0xe3)){const s=await(0x0,sharp_1[C(0xc5)])(o)['jpeg']()[B(0xd6)]();g=await c[B(0xcb)](k,s,{'filename':i[B(0xe0)]});}i[B(0xa3)]===C(0xbe)&&(g=await c[C(0xb3)](k,o,{'filename':i[B(0xe0)]})),[C(0xd7),B(0xb2),C(0xdd)][B(0xae)](i[B(0xa3)])&&(g=await c['sendFile'](k,o,{'filename':i[C(0xe0)]}));}[C(0xb5),C(0xd0)][C(0xae)](i[B(0xa3)])&&!i[C(0xe0)]&&(g=await c['sendText'](k,i['body']));const l={...i,...g,'id':i['id'],'timestamp':i[B(0xac)],'messageId':g[B(0xc0)],'status':B(0xba),'ack':0x2};await Message_1[B(0xc5)]['update']({...l},{'where':{'id':i['id']}}),(0x0,socketEmit_1[C(0xc5)])({'tenantId':j[C(0xab)],'type':C(0xad),'payload':{...i[B(0xd9)],'mediaUrl':i['mediaUrl'],'id':i['id'],'timestamp':i[B(0xac)],'messageId':g['messageId'],'status':C(0xba),'ack':0x2}}),logger_1[B(0xb6)]['info'](C(0xca)),await(0x0,sleepRandomTime_1[C(0xd5)])({'minMilliseconds':Number(0x1f4),'maxMilliseconds':Number(0x5dc)});}catch(t){const u=i['id'],v=i[C(0xd2)]['id'];logger_1['logger'][C(0xa6)](C(0xb8)+d+B(0xcf)+v+')'),logger_1['logger'][C(0xa6)]('Error\x20send\x20message\x20(id:\x20'+u+B(0xa1)+t);}}};exports[A(0xc5)]=MessengerSendMessagesSystem;