'use strict';function a(){const W=['split','../../libs/Queue','1936WNduxs','campaginId_','add','floor','delay','90648prMlgG','312YXRnnj','ERR_CAMPAIGN_CONTACTS_NOT_EXISTS','3172aJcuiz','isBefore','number','getHours','__importDefault','sessionId','differenceInSeconds','getMinutes','../../models/CampaignContacts','_time_','default','session','28805oYipqq','addDays','1988FYKgGo','getTime','message3','message2','08:00','contact','8757sIzprq','520lwwoCH','setMinutes','America/Sao_Paulo','54920oXQKjA','map','isWithinInterval','ESwHA','message1','scheduled','setHours','SendMessageWhatsappCampaign','1890FStxwD','__esModule','date-fns','mediaUrl','addSeconds','../../models/Campaign','20:00','zonedTimeToUtc','findAll','contactId','start','56EQdHRP','40184NRKvSI','_id_','54537678QWxKnf','HH:mm'];a=function(){return W;};return a();}const I=b,K=b;(function(c,d){const G=b,H=b,e=c();while(!![]){try{const f=-parseInt(G(0x106))/0x1*(-parseInt(G(0x11b))/0x2)+-parseInt(H(0x11a))/0x3*(parseInt(G(0x114))/0x4)+parseInt(H(0x112))/0x5*(-parseInt(G(0x104))/0x6)+-parseInt(G(0xf7))/0x7*(parseInt(H(0xf8))/0x8)+-parseInt(H(0x126))/0x9*(parseInt(G(0x11e))/0xa)+-parseInt(H(0xfe))/0xb*(parseInt(H(0x103))/0xc)+parseInt(H(0xfa))/0xd;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0xb646b));var __importDefault=this&&this[I(0x10a)]||function(c){const J=I;return c&&c[J(0x127)]?c:{'default':c};};Object['defineProperty'](exports,I(0x127),{'value':!![]});function b(c,d){const e=a();return b=function(f,g){f=f-0xf0;let h=e[f];return h;},b(c,d);}const date_fns_1=require(K(0x128)),date_fns_tz_1=require('date-fns-tz'),Campaign_1=__importDefault(require(I(0xf1))),AppError_1=__importDefault(require('../../errors/AppError')),CampaignContacts_1=__importDefault(require(I(0x10e))),Queue_1=__importDefault(require(K(0xfd))),cArquivoName=c=>{const L=K;if(!c)return'';const d=c[L(0xfc)]('/'),e=d[d['length']-0x1];return e;},randomInteger=(c,d)=>{const M=I;return Math[M(0x101)](Math['random']()*(d-c+0x1))+c;},mountMessageData=(c,d,e)=>{const N=K,O=I,f=randomInteger(0x1,0x3);let g='';if(f===0x1)g=c[N(0x122)];if(f===0x2)g=c[O(0x117)];if(f===0x3)g=c[O(0x116)];return{'whatsappId':c[N(0x10b)],'message':g,'number':d[N(0x119)][O(0x108)],'mediaUrl':c[N(0x129)],'mediaName':cArquivoName(c[O(0x129)]),'messageRandom':'message'+f,'campaignContact':d,'options':e};},nextDayHoursValid=c=>{const P=I,Q=K;let d=c;const e=new Date(),f=(0x0,date_fns_1['differenceInDays'])(d,new Date());f<0x0&&(d=(0x0,date_fns_1[P(0x113)])(d,f*-0x1));d[P(0x115)]()<e[Q(0x115)]()&&(d=(0x0,date_fns_1[Q(0x11c)])((0x0,date_fns_1[P(0x124)])(d,e[P(0x109)]()),e[Q(0x10d)]()));const g=(0x0,date_fns_1['parse'])(Q(0x118),Q(0xfb),d),h=(0x0,date_fns_1['parse'])(Q(0xf2),'HH:mm',d),i=(0x0,date_fns_1[Q(0x120)])(d,{'start':g,'end':h}),j=(0x0,date_fns_1[P(0x107)])(g,d),k=(0x0,date_fns_1['isAfter'])(h,d);return!i&&j&&(d=(0x0,date_fns_1[P(0x11c)])((0x0,date_fns_1['setHours'])(d,0x8),0x1e)),!i&&k&&f===0x0&&(d=(0x0,date_fns_1[P(0x113)])((0x0,date_fns_1['setHours'])(d,0x8),0x1)),!i&&k&&f>0x0&&(d=(0x0,date_fns_1[Q(0x124)])(d,0x8)),d;},calcDelay=(c,d)=>{const R=K,e=(0x0,date_fns_1[R(0x10c)])(c,new Date());return e*0x3e8+d;},StartCampaignService=async({campaignId:c,tenantId:d,options:e})=>{const S=K,T=K,f=await Campaign_1['default']['findOne']({'where':{'id':c,'tenantId':d},'include':[S(0x111)]});if(!f)throw new AppError_1[(S(0x110))]('ERROR_CAMPAIGN_NOT_EXISTS',0x194);const g=await CampaignContacts_1[S(0x110)][S(0xf4)]({'where':{'campaignId':c},'include':[S(0x119)]});if(!g){if(T(0x121)===S(0x121))throw new AppError_1[(S(0x110))](S(0x105),0x194);else g=(0x0,h[T(0x11c)])((0x0,i[S(0x124)])(j,0x8),0x1e);}const h=f[T(0x102)]?f['delay']*0x3e8:0x4e20;let i=(0x0,date_fns_tz_1[S(0xf3)])(f[T(0xf6)],T(0x11d));const j=g[S(0x11f)](l=>{const U=T,V=S;return i=(0x0,date_fns_1[U(0xf0)])(i,h/0x3e8),mountMessageData(f,l,{...e,'jobId':V(0xff)+f['id']+'_contact_'+l[V(0xf5)]+U(0xf9)+l['id']+V(0x10f)+f[U(0xf6)][U(0x115)](),'delay':calcDelay(i,h)});});Queue_1[T(0x110)][S(0x100)](T(0x125),j),await f['update']({'status':T(0x123)});};exports['default']=StartCampaignService;