'use strict';const I=b,K=b;(function(c,d){const G=b,H=b,e=c();while(!![]){try{const f=-parseInt(G(0x200))/0x1*(parseInt(G(0x1d7))/0x2)+parseInt(H(0x208))/0x3*(-parseInt(H(0x209))/0x4)+parseInt(H(0x213))/0x5*(-parseInt(G(0x1f7))/0x6)+parseInt(G(0x20c))/0x7*(-parseInt(G(0x1f1))/0x8)+parseInt(G(0x1e8))/0x9*(-parseInt(H(0x20f))/0xa)+parseInt(H(0x1f0))/0xb+-parseInt(H(0x214))/0xc*(-parseInt(G(0x1dc))/0xd);if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x53df0));var __importDefault=this&&this[I(0x1d9)]||function(c){const J=I;return c&&c[J(0x1d8)]?c:{'default':c};};Object[I(0x1e5)](exports,I(0x1d8),{'value':!![]});function a(){const X=['addSeconds','contact','412BsKoOW','zonedTimeToUtc','setHours','random','getHours','GAQZN','start','getTime','1497KxTJNH','5028RmSghc','message2','split','29715PTMgJD','_contact_','message1','90720xJNFDy','contactId','20:00','message','5PxTahn','768XGALxo','map','findAll','1814ESlZqY','__esModule','__importDefault','isBefore','ERROR_CAMPAIGN_NOT_EXISTS','367757mHbInv','mediaUrl','floor','setMinutes','America/Sao_Paulo','../../models/Campaign','date-fns','GvmPl','AekaD','defineProperty','add','session','549RKbwPc','message3','QTJos','length','getMinutes','HH:mm','scheduled','date-fns-tz','5534958zuPsJQ','360HjZDPI','default','../../models/CampaignContacts','_time_','addDays','delay','1348764KuPqee','UQMhT','sessionId','ovnJr','isAfter','../../errors/AppError','number'];a=function(){return X;};return a();}function b(c,d){const e=a();return b=function(f,g){f=f-0x1d7;let h=e[f];return h;},b(c,d);}const date_fns_1=require(K(0x1e2)),date_fns_tz_1=require(K(0x1ef)),Campaign_1=__importDefault(require(I(0x1e1))),AppError_1=__importDefault(require(K(0x1fc))),CampaignContacts_1=__importDefault(require(K(0x1f3))),Queue_1=__importDefault(require('../../libs/Queue')),cArquivoName=c=>{const L=K,M=I;if(!c)return'';const d=c[L(0x20b)]('/'),e=d[d[L(0x1eb)]-0x1];return e;},randomInteger=(c,d)=>{const N=K,O=K;return Math[N(0x1de)](Math[O(0x203)]()*(d-c+0x1))+c;},mountMessageData=(c,d,e)=>{const P=K,Q=K,f=randomInteger(0x1,0x3);let g='';if(f===0x1)g=c[P(0x20e)];if(f===0x2)g=c[P(0x20a)];if(f===0x3)g=c[Q(0x1e9)];return{'whatsappId':c['sessionId'],'message':g,'number':d[Q(0x1ff)][Q(0x1fd)],'mediaUrl':c[P(0x1dd)],'mediaName':cArquivoName(c['mediaUrl']),'messageRandom':P(0x212)+f,'campaignContact':d,'options':e};},nextDayHoursValid=c=>{const R=I,S=I;let d=c;const e=new Date(),f=(0x0,date_fns_1['differenceInDays'])(d,new Date());f<0x0&&(d=(0x0,date_fns_1[R(0x1f5)])(d,f*-0x1));d[R(0x207)]()<e[R(0x207)]()&&(R(0x1e4)==='AekaD'?d=(0x0,date_fns_1['setMinutes'])((0x0,date_fns_1['setHours'])(d,e[R(0x204)]()),e[S(0x1ec)]()):g=(0x0,h['addDays'])((0x0,i[S(0x202)])(j,0x8),0x1));const g=(0x0,date_fns_1['parse'])('08:00',R(0x1ed),d),h=(0x0,date_fns_1['parse'])(R(0x211),R(0x1ed),d),i=(0x0,date_fns_1['isWithinInterval'])(d,{'start':g,'end':h}),j=(0x0,date_fns_1[S(0x1da)])(g,d),k=(0x0,date_fns_1[S(0x1fb)])(h,d);if(!i&&j){if('osoom'!==S(0x205))d=(0x0,date_fns_1[R(0x1df)])((0x0,date_fns_1[R(0x202)])(d,0x8),0x1e);else{const n=n(0x1,0x3);let o='';if(n===0x1)o=o['message1'];if(n===0x2)o=p['message2'];if(n===0x3)o=q['message3'];return{'whatsappId':r[S(0x1f9)],'message':o,'number':s[R(0x1ff)][R(0x1fd)],'mediaUrl':t[R(0x1dd)],'mediaName':u(v[S(0x1dd)]),'messageRandom':R(0x212)+n,'campaignContact':w,'options':x};}}return!i&&k&&f===0x0&&(R(0x1f8)!==R(0x1ea)?d=(0x0,date_fns_1[S(0x1f5)])((0x0,date_fns_1['setHours'])(d,0x8),0x1):i=(0x0,j[S(0x1df)])((0x0,k[R(0x202)])(l,m['getHours']()),n[S(0x1ec)]())),!i&&k&&f>0x0&&(d=(0x0,date_fns_1[R(0x202)])(d,0x8)),d;},calcDelay=(c,d)=>{const e=(0x0,date_fns_1['differenceInSeconds'])(c,new Date());return e*0x3e8+d;},StartCampaignService=async({campaignId:c,tenantId:d,options:e})=>{const T=K,U=I,f=await Campaign_1[T(0x1f2)]['findOne']({'where':{'id':c,'tenantId':d},'include':[U(0x1e7)]});if(!f){if(U(0x1fa)===T(0x1fa))throw new AppError_1[(T(0x1f2))](T(0x1db),0x194);else return g&&h[T(0x1d8)]?i:{'default':j};}const g=await CampaignContacts_1[U(0x1f2)][U(0x216)]({'where':{'campaignId':c},'include':[T(0x1ff)]});if(!g){if(U(0x1e3)!==T(0x1e3))g=(0x0,h[U(0x1f5)])(i,j*-0x1);else throw new AppError_1[(U(0x1f2))]('ERR_CAMPAIGN_CONTACTS_NOT_EXISTS',0x194);}const h=f['delay']?f[T(0x1f6)]*0x3e8:0x4e20;let i=(0x0,date_fns_tz_1[T(0x201)])(f[T(0x206)],T(0x1e0));const j=g[T(0x215)](m=>{const V=T,W=T;return i=(0x0,date_fns_1[V(0x1fe)])(i,h/0x3e8),mountMessageData(f,m,{...e,'jobId':'campaginId_'+f['id']+V(0x20d)+m[V(0x210)]+'_id_'+m['id']+V(0x1f4)+f['start'][W(0x207)](),'delay':calcDelay(i,h)});});Queue_1['default'][U(0x1e6)]('SendMessageWhatsappCampaign',j),await f['update']({'status':T(0x1ee)});};exports[K(0x1f2)]=StartCampaignService;